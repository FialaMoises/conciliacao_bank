<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concilia√ß√£o Banc√°ria - Sistema de Upload</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="table-fixes.css">
    <link rel="stylesheet" href="billing-rules.css">
    <link rel="stylesheet" href="streaming-animations.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>Concilia√ß√£o Banc√°ria</h1>
            </div>
            <div class="status-indicator" id="apiStatus">
                <i class="fas fa-circle"></i>
                <span>Verificando API...</span>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="reconciliation" onclick="switchMainSection('reconciliation')">
                    <i class="fas fa-chart-line"></i>
                    Concilia√ß√£o
                </button>
                <button class="nav-tab" data-section="reconciliation-rules" onclick="switchMainSection('reconciliation-rules')">
                    <i class="fas fa-robot"></i>
                    Regras de Concilia√ß√£o
                </button>
                <button class="nav-tab" data-section="settings" onclick="switchMainSection('settings')">
                    <i class="fas fa-cog"></i>
                    Configura√ß√µes
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Reconciliation Section -->
            <div class="main-section active" id="reconciliation-section">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-card">
                    <div class="upload-header">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h2>Upload de Extrato Banc√°rio</h2>
                        <p>Envie seus arquivos OFX, CSV, TXT, XLS ou XLSX para an√°lise autom√°tica</p>
                    </div>

                    <div class="file-drop-zone" id="dropZone">
                        <div class="drop-content">
                            <i class="fas fa-file-upload"></i>
                            <p>Arraste e solte o arquivo aqui ou <button type="button" class="browse-btn" onclick="document.getElementById('fileInput').click()">clique para selecionar</button></p>
                            <small>Formatos aceitos: OFX, CSV, TXT, XLS, XLSX (m√°x. 16MB)</small>
                        </div>
                        <input type="file" id="fileInput" accept=".ofx,.csv,.txt,.xls,.xlsx" style="display: none;">
                    </div>

                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file-alt"></i>
                            <div class="file-meta">
                                <span class="file-name" id="fileName"></span>
                                <span class="file-size" id="fileSize"></span>
                            </div>
                            <button class="remove-file" id="removeFile">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- File Structure Info - Shown for all supported files -->
                    <div class="file-structure-fields" id="fileStructureFields" style="display: none;">
                        <h3>Estrutura√ß√£o de Arquivo</h3>
                        <p class="field-description">Arquivo <span id="fileTypeDisplay">-</span> ser√° estruturado automaticamente com as configura√ß√µes:</p>
                        
                        <div class="fixed-config-info">
                            <div class="config-item" id="bankInfoDisplay">
                                <strong>üè¶ Banco:</strong> <span id="bankNameDisplay">Detectando...</span>
                            </div>
                            <div class="config-item" id="accountInfoDisplay" style="display: none;">
                                <strong>üèß Ag√™ncia/Conta:</strong> <span id="accountDetailsDisplay">-</span>
                            </div>
                            <div class="config-item">
                                <strong>üíæ Destino:</strong> MongoDB ‚Üí holdprint-db-2356 ‚Üí BankReconciliation
                            </div>
                            <div class="config-item">
                                <strong>üîÑ Status:</strong> Estrutura√ß√£o autom√°tica ativa
                            </div>
                            <div class="config-item" id="structureTypeInfo">
                                <strong>üìä Processamento:</strong> <span id="processingTypeText">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="upload-actions">
                        <button class="btn btn-primary" id="uploadBtn" disabled>
                            <i class="fas fa-rocket"></i>
                            Iniciar Concilia√ß√£o
                        </button>
                        <button class="btn btn-success" id="structureBtn" disabled style="display: none;">
                            <i class="fas fa-database"></i>
                            Estruturar Arquivo
                        </button>
                        <button class="btn btn-secondary" id="clearBtn" style="display: none;">
                            <i class="fas fa-redo"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </section>

            <!-- Progress Section -->
            <section class="progress-section streaming-section" id="progressSection" style="display: none;">
                <div class="progress-card streaming-card">
                    <div class="progress-header streaming-header">
                        <i class="fas fa-cog fa-spin status-icon" id="statusIcon"></i>
                        <h3 id="statusTitle">Processando Concilia√ß√£o</h3>
                        <div class="connection-status" id="connectionStatus">
                            <span class="status-dot connected" id="statusDot"></span>
                            <span class="status-text" id="statusText">Conectado</span>
                        </div>
                    </div>

                    <!-- Progress Bar with Animation -->
                    <div class="progress-container">
                        <div class="progress-bar animated-progress">
                            <div class="progress-fill streaming-progress" id="progressFill"></div>
                            <div class="progress-text" id="progressText">Iniciando processamento...</div>
                        </div>
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                    </div>

                    <!-- Step Indicators -->
                    <div class="step-indicators" id="stepIndicators">
                        <div class="step-item" data-step="0">
                            <div class="step-circle"><i class="fas fa-upload"></i></div>
                            <span class="step-label">Upload</span>
                        </div>
                        <div class="step-item" data-step="1">
                            <div class="step-circle"><i class="fas fa-file-alt"></i></div>
                            <span class="step-label">An√°lise</span>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-circle"><i class="fas fa-search"></i></div>
                            <span class="step-label">Extra√ß√£o</span>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-circle"><i class="fas fa-database"></i></div>
                            <span class="step-label">MongoDB</span>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="step-circle"><i class="fas fa-sync-alt"></i></div>
                            <span class="step-label">Processamento</span>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="step-circle"><i class="fas fa-brain"></i></div>
                            <span class="step-label">LLM</span>
                        </div>
                        <div class="step-item" data-step="6">
                            <div class="step-circle"><i class="fas fa-chart-line"></i></div>
                            <span class="step-label">An√°lise</span>
                        </div>
                        <div class="step-item" data-step="7">
                            <div class="step-circle"><i class="fas fa-check"></i></div>
                            <span class="step-label">Resultados</span>
                        </div>
                    </div>

                    <!-- Real-time Counters -->
                    <div class="counters-grid" id="countersGrid">
                        <div class="counter-item">
                            <div class="counter-icon"><i class="fas fa-file-upload"></i></div>
                            <div class="counter-content">
                                <div class="counter-number" id="uploadedCount">0</div>
                                <div class="counter-label">Arquivos</div>
                            </div>
                        </div>
                        <div class="counter-item">
                            <div class="counter-icon"><i class="fas fa-list"></i></div>
                            <div class="counter-content">
                                <div class="counter-number" id="extractedCount">0</div>
                                <div class="counter-label">Transa√ß√µes</div>
                            </div>
                        </div>
                        <div class="counter-item">
                            <div class="counter-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="counter-content">
                                <div class="counter-number" id="processedCount">0</div>
                                <div class="counter-label">Processadas</div>
                            </div>
                        </div>
                        <div class="counter-item">
                            <div class="counter-icon"><i class="fas fa-link"></i></div>
                            <div class="counter-content">
                                <div class="counter-number" id="matchesCount">0</div>
                                <div class="counter-label">Matches</div>
                            </div>
                        </div>
                    </div>

                    <!-- File Analysis Section -->
                    <div class="file-analysis" id="fileAnalysis" style="display: none;">
                        <h4><i class="fas fa-file-alt"></i> An√°lise do Arquivo</h4>
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <div class="analysis-icon">
                                    <i class="fas fa-file-code"></i>
                                </div>
                                <div class="analysis-content">
                                    <div class="analysis-label">Formato</div>
                                    <div class="analysis-value" id="fileFormat">--</div>
                                </div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-icon">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div class="analysis-content">
                                    <div class="analysis-label">Banco</div>
                                    <div class="analysis-value" id="bankDetected">--</div>
                                </div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="analysis-content">
                                    <div class="analysis-label">Per√≠odo</div>
                                    <div class="analysis-value" id="dateRange">--</div>
                                </div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-icon">
                                    <i class="fas fa-weight"></i>
                                </div>
                                <div class="analysis-content">
                                    <div class="analysis-label">Tamanho</div>
                                    <div class="analysis-value" id="fileSize">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="financial-summary">
                            <div class="financial-item expense">
                                <div class="financial-icon">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="financial-content">
                                    <div class="financial-label">Despesas</div>
                                    <div class="financial-value">
                                        <span class="financial-count" id="expensesCount">0</span>
                                        <span class="financial-amount" id="expensesAmount">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="financial-item income">
                                <div class="financial-icon">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div class="financial-content">
                                    <div class="financial-label">Receitas</div>
                                    <div class="financial-value">
                                        <span class="financial-count" id="incomesCount">0</span>
                                        <span class="financial-amount" id="incomesAmount">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="financial-item total">
                                <div class="financial-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="financial-content">
                                    <div class="financial-label">Total Movimentado</div>
                                    <div class="financial-value">
                                        <span class="financial-amount large" id="totalAmount">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event Timeline -->
                    <div class="event-timeline" id="eventTimeline">
                        <h4><i class="fas fa-history"></i> Timeline de Eventos</h4>
                        <div class="timeline-container" id="timelineContainer">
                            <div class="timeline-item initial">
                                <div class="timeline-time">--:--</div>
                                <div class="timeline-content">
                                    <div class="timeline-event">Sistema inicializado</div>
                                    <div class="timeline-details">Aguardando arquivo...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h2>Resultados da Concilia√ß√£o</h2>
                    <div class="results-actions">
                        <button class="btn btn-outline" id="downloadBtn">
                            <i class="fas fa-download"></i>
                            Baixar Relat√≥rio
                        </button>
                        <button class="btn btn-outline" id="newAnalysisBtn">
                            <i class="fas fa-plus"></i>
                            Nova An√°lise
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid">
                    <div class="summary-card success">
                        <div class="summary-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="conciliatedCount">0</h3>
                            <p>Conciliadas</p>
                        </div>
                    </div>
                    <div class="summary-card suggestion">
                        <div class="summary-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="suggestedCount">0</h3>
                            <p>Sugeridas</p>
                        </div>
                    </div>
                    <div class="summary-card pending">
                        <div class="summary-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="pendingCount">0</h3>
                            <p>Pendentes</p>
                        </div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="noCorrelationCount">0</h3>
                            <p>Sem Correla√ß√£o</p>
                        </div>
                    </div>
                    <div class="summary-card info">
                        <div class="summary-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="summary-content">
                            <h3 id="unmatchedMongoCount">0</h3>
                            <p>Liquidado</p>
                        </div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="results-details">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="conciliated">
                            <i class="fas fa-check"></i>
                            Conciliadas
                        </button>
                        <button class="tab-btn" data-tab="suggested">
                            <i class="fas fa-lightbulb"></i>
                            Sugeridas
                        </button>
                        <button class="tab-btn" data-tab="pending">
                            <i class="fas fa-clock"></i>
                            Pendentes
                        </button>
                        <button class="tab-btn" data-tab="no-correlation">
                            <i class="fas fa-exclamation-triangle"></i>
                            Sem Correla√ß√£o
                        </button>
                        <button class="tab-btn" data-tab="unmatched-mongo">
                            <i class="fas fa-database"></i>
                            Liquidado
                        </button>
                    </div>

                    <div class="tab-content active" id="conciliated-tab">
                        <div class="table-container">
                            <div class="status-actions">
                                <button class="btn-action btn-liquidate" id="liquidateSelectedBtn" onclick="openLiquidationModal()" style="display: none;">
                                    <i class="fas fa-stamp"></i>
                                    Liquidar Selecionados
                                </button>
                                <div class="selection-info" id="conciliatedSelectionInfo" style="display: none;">
                                    <span><strong id="selectedCount">0</strong> transa√ß√µes selecionadas</span>
                                    <span class="total-value">Total: <strong id="selectedTotalValue">R$ 0,00</strong></span>
                                </div>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllConciliated" onchange="toggleSelectAllConciliated()"></th>
                                        <th colspan="4" class="section-header">Transa√ß√£o Banc√°ria</th>
                                        <th colspan="4" class="section-header">Documento do Sistema</th>
                                        <th rowspan="2" class="match-info">Categoria</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Tipo</th>
                                        <th>ID</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Data Vencimento</th>
                                    </tr>
                                </thead>
                                <tbody id="conciliatedTable">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="suggested-tab">
                        <div class="table-container">
                            <div class="status-actions">
                                <button class="btn-action btn-approve" onclick="approveSelectedItems('suggested')">
                                    <i class="fas fa-check"></i>
                                    Aprovar Selecionados
                                </button>
                                <button class="btn-action btn-reject" onclick="rejectSelectedItems('suggested')">
                                    <i class="fas fa-times"></i>
                                    Rejeitar Selecionados
                                </button>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllSuggested" onchange="toggleSelectAll('suggested')"></th>
                                        <th colspan="4" class="section-header">Transa√ß√£o Banc√°ria</th>
                                        <th colspan="4" class="section-header">Documento do Sistema</th>
                                        <th rowspan="2" class="match-info">Categoria</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Tipo</th>
                                        <th>ID</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Data Vencimento</th>
                                    </tr>
                                </thead>
                                <tbody id="suggestedTable">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="pending-tab">
                        <div class="table-container">
                            <div class="status-actions">
                                <button class="btn-action btn-approve" onclick="approveSelectedItems('pending')">
                                    <i class="fas fa-check"></i>
                                    Aprovar Selecionados
                                </button>
                                <button class="btn-action btn-reject" onclick="rejectSelectedItems('pending')">
                                    <i class="fas fa-times"></i>
                                    Rejeitar Selecionados
                                </button>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllPending" onchange="toggleSelectAll('pending')"></th>
                                        <th colspan="4" class="section-header">Transa√ß√£o Banc√°ria</th>
                                        <th colspan="4" class="section-header">Documento do Sistema</th>
                                        <th rowspan="2" class="match-info">Categoria</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Tipo</th>
                                        <th>ID</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Data Vencimento</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Nova aba: Sem Correla√ß√£o no Sistema -->
                    <div class="tab-content" id="no-correlation-tab">
                        <div class="table-container">
                            <div class="info-box warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Transa√ß√µes sem Correla√ß√£o no Sistema</strong>
                                    <p>Estas transa√ß√µes banc√°rias n√£o possuem documentos correspondentes no sistema (MongoDB).</p>
                                </div>
                            </div>
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Motivo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="noCorrelationTable">
                                    <!-- Transa√ß√µes sem correla√ß√£o ser√£o carregadas aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <div class="tab-content" id="unmatched-mongo-tab">
                        <div class="table-container">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>ID do Documento</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Data Vencimento</th>
                                        <th>Data Liquida√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="unmatchedMongoTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Error Section -->
            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-card">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="error-content">
                        <h3>Erro no Processamento</h3>
                        <p id="errorMessage"></p>
                        <button class="btn btn-primary" onclick="resetForm()">
                            <i class="fas fa-redo"></i>
                            Tentar Novamente
                        </button>
                    </div>
                </div>
            </section>
            </div>

            <!-- Reconciliation Rules Section -->
            <div class="main-section" id="reconciliation-rules-section" style="display: none;">
                <div class="rules-header">
                    <div class="rules-title">
                        <h2><i class="fas fa-robot"></i> Regras de Concilia√ß√£o</h2>
                        <p>Configure prompts personalizados para a LLM processar a concilia√ß√£o</p>
                    </div>
                    <div class="rules-actions">
                        <button class="btn btn-primary" onclick="showCreatePromptModal()">
                            <i class="fas fa-plus"></i>
                            Novo Prompt
                        </button>
                    </div>
                </div>

                <!-- Rules Stats -->
                <div class="rules-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalRulesCount">0</h3>
                            <p>Total de Prompts</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeRulesCount">0</h3>
                            <p>Prompts Ativos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-pause-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="inactiveRulesCount">0</h3>
                            <p>Prompts Inativos</p>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="rules-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPromptInput" placeholder="Buscar prompts..." onkeyup="filterPrompts()">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterPromptsByStatus('all')">Todos</button>
                        <button class="filter-btn" onclick="filterPromptsByStatus('active')">Ativos</button>
                        <button class="filter-btn" onclick="filterPromptsByStatus('inactive')">Inativos</button>
                    </div>
                </div>

                <!-- Rules Table -->
                <div class="rules-table-container">
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>Nome do Prompt</th>
                                <th>Tipo</th>
                                <th>Conte√∫do</th>
                                <th>Contexto</th>
                                <th>Prioridade</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="promptsTableBody">
                            <!-- Prompts ser√£o carregados aqui -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="promptsEmptyState">
                        <i class="fas fa-robot"></i>
                        <h3>Nenhum prompt configurado</h3>
                        <p>Crie seu primeiro prompt para personalizar a concilia√ß√£o</p>
                        <button class="btn btn-primary" onclick="showCreatePromptModal()">
                            <i class="fas fa-plus"></i>
                            Criar Primeiro Prompt
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="main-section" id="settings-section" style="display: none;">
                <div class="settings-header">
                    <h2><i class="fas fa-cog"></i> Configura√ß√µes</h2>
                </div>
                
                <div class="settings-grid">
                    <!-- API Configuration -->
                    <div class="settings-card">
                        <h3><i class="fas fa-server"></i> Configura√ß√£o da API</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>URL da API</label>
                                <input type="text" id="apiUrl" value="https://holdprintwebbankreconciliation-test.azurewebsites.net" placeholder="https://holdprintwebbankreconciliation-test.azurewebsites.net">
                            </div>
                            <div class="form-group">
                                <label>Timeout (ms)</label>
                                <input type="number" id="apiTimeout" value="30000" min="5000" max="120000">
                            </div>
                            <button class="btn btn-primary" onclick="saveApiSettings()">
                                <i class="fas fa-save"></i>
                                Salvar Configura√ß√µes
                            </button>
                        </div>
                    </div>
                    
                    <!-- MongoDB Configuration -->
                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> Configura√ß√£o do MongoDB</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>String de Conex√£o</label>
                                <input type="text" id="mongoUri" placeholder="mongodb://localhost:27017/conciliacao">
                            </div>
                            <div class="form-group">
                                <label>Nome do Banco</label>
                                <input type="text" id="mongoDatabase" placeholder="conciliacao">
                            </div>
                            <button class="btn btn-primary" onclick="testMongoConnection()">
                                <i class="fas fa-plug"></i>
                                Testar Conex√£o
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export/Import -->
                    <div class="settings-card">
                        <h3><i class="fas fa-file-export"></i> Exportar/Importar</h3>
                        <div class="settings-form">
                            <button class="btn btn-outline" onclick="exportSettings()">
                                <i class="fas fa-download"></i>
                                Exportar Configura√ß√µes
                            </button>
                            <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload"></i>
                                Importar Configura√ß√µes
                            </button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(event)">
                        </div>
                    </div>
                </div>
            </div>
                
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2025 Sistema de Concilia√ß√£o Banc√°ria. Vers√£o 1.0</p>
                <div class="footer-links">
                    <a href="#" onclick="showApiConfig()">Configura√ß√µes da API</a>
                    <a href="#" onclick="showHelp()">Ajuda</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processando...</p>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- Create/Edit Prompt Modal -->
    <div class="modal" id="promptModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="promptModalTitle">
                    <i class="fas fa-plus-circle"></i>
                    Novo Prompt de Concilia√ß√£o
                </h3>
                <button class="modal-close" onclick="closePromptModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="promptForm" class="rule-form" onsubmit="return false;">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4><i class="fas fa-info-circle"></i> Informa√ß√µes B√°sicas</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="promptName">Nome do Prompt *</label>
                                <input type="text" id="promptName" name="name" required placeholder="Ex: Concilia√ß√£o com Juros e Multas">
                            </div>
                            <div class="form-group">
                                <label for="promptType">Tipo de Prompt *</label>
                                <select id="promptType" name="type" required>
                                    <option value="billing">Cobran√ßa (Juros/Multas)</option>
                                    <option value="matching">Correspond√™ncia Especial</option>
                                    <option value="validation">Valida√ß√£o Customizada</option>
                                    <option value="general">Geral</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="promptPriority">Prioridade</label>
                                <input type="number" id="promptPriority" name="priority" value="1" min="1" max="100">
                                <small>Menor n√∫mero = maior prioridade</small>
                            </div>
                            <div class="form-group">
                                <label for="promptActive">Status</label>
                                <select id="promptActive" name="active">
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompt Content -->
                    <div class="form-section">
                        <h4><i class="fas fa-robot"></i> Conte√∫do do Prompt</h4>
                        <div class="form-group">
                            <label for="promptContent">Prompt para LLM *</label>
                            <textarea id="promptContent" name="content" required rows="10" placeholder="Digite aqui o prompt que ser√° enviado para a LLM durante a concilia√ß√£o...

Exemplo:
Ao realizar a concilia√ß√£o banc√°ria, considere que a diferen√ßa entre o valor previsto no sistema e o valor encontrado no extrato banc√°rio pode ser causada pela aplica√ß√£o de multa e/ou juros.

Regras de c√°lculo:
- Multa: 2,0% do valor principal, aplicada ap√≥s o vencimento
- Juros: 1,0% ao m√™s (juros simples), aplicados proporcionalmente aos dias de atraso

Instru√ß√µes:
1. Se houver diferen√ßa positiva no valor pago/recebido, verifique se ela √© compat√≠vel com multa + juros
2. Calcule juros proporcionais: (valor_principal * taxa_juros / 100) * (dias_atraso / 30)
3. Informe se a diferen√ßa foi explicada por multa/juros e detalhe o c√°lculo"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="promptContext">Contexto de Aplica√ß√£o</label>
                            <textarea id="promptContext" name="context" rows="3" placeholder="Descreva quando este prompt deve ser aplicado. Ex: Para transa√ß√µes vencidas, valores divergentes, etc."></textarea>
                        </div>
                    </div>
                    
                    <!-- NOVA VERS√ÉO: Sistema 100% LLM - Sem campos t√©cnicos -->
                    <div class="form-section">
                        <h4><i class="fas fa-brain"></i> Sistema Inteligente</h4>
                        <div class="form-group">
                            <div style="padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <h5 style="margin: 0 0 0.5rem 0;"><i class="fas fa-magic"></i> Nova Funcionalidade: LLM Inteligente</h5>
                                <p style="margin: 0; font-size: 0.9rem;">
                                    Agora voc√™ pode escrever regras em <strong>linguagem natural</strong>! O sistema ir√° interpretar automaticamente as datas e a√ß√µes necess√°rias.
                                </p>
                            </div>
                            <div style="padding: 0.75rem; background: #e8f5e8; border-left: 4px solid #28a745; border-radius: 0.375rem; font-size: 0.9rem;">
                                <h6 style="margin: 0 0 0.5rem 0; color: #155724;"><i class="fas fa-lightbulb"></i> Exemplos de regras inteligentes:</h6>
                                <ul style="margin: 0; padding-left: 1.5rem; color: #155724;">
                                    <li><strong>"Tudo no m√™s de julho deve ser sugerido"</strong></li>
                                    <li><strong>"Transa√ß√µes de dezembro ficam pendentes para revis√£o"</strong></li>
                                    <li><strong>"Valores acima de R$ 1000 devem ser conciliados automaticamente"</strong></li>
                                    <li><strong>"Entre 01/06 e 30/06, marcar tudo como sugerido"</strong></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closePromptModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePrompt()">
                    <i class="fas fa-save"></i>
                    Salvar Prompt
                </button>
            </div>
        </div>
    </div>

    <!-- Old Rule Modal - Hidden -->
    <div style="display: none;">
                    <!-- Fine Configuration -->
                    <div class="form-section">
                        <h4><i class="fas fa-exclamation-triangle"></i> Configura√ß√£o de Multa</h4>
                        <div class="form-row">
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="fineEnabled" name="fine_enabled" checked>
                                    <span class="checkmark"></span>
                                    Aplicar multa
                                </label>
                            </div>
                        </div>
                        <div class="form-row" id="fineSettings">
                            <div class="form-group">
                                <label for="finePercentage">Percentual da Multa (%)</label>
                                <input type="number" id="finePercentage" name="fine_percentage" value="2.0" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label for="fineGraceDays">Dias de Car√™ncia</label>
                                <input type="number" id="fineGraceDays" name="fine_grace_days" value="0" min="0">
                                <small>Dias sem multa ap√≥s vencimento</small>
                            </div>
                        </div>
                    </div>

                    <!-- Interest Configuration -->
                    <div class="form-section">
                        <h4><i class="fas fa-percentage"></i> Configura√ß√£o de Juros</h4>
                        <div class="form-row">
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="interestEnabled" name="interest_enabled" checked>
                                    <span class="checkmark"></span>
                                    Aplicar juros
                                </label>
                            </div>
                        </div>
                        <div class="form-row" id="interestSettings">
                            <div class="form-group">
                                <label for="interestRate">Taxa de Juros (%)</label>
                                <input type="number" id="interestRate" name="interest_rate" value="1.0" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label for="interestType">Tipo de Juros</label>
                                <select id="interestType" name="interest_type">
                                    <option value="MONTHLY">Mensal</option>
                                    <option value="DAILY">Di√°rio</option>
                                    <option value="YEARLY">Anual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="interestSettings2">
                            <div class="form-group">
                                <label for="interestGraceDays">Dias de Car√™ncia</label>
                                <input type="number" id="interestGraceDays" name="interest_grace_days" value="0" min="0">
                                <small>Dias sem juros ap√≥s vencimento</small>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="compoundInterest" name="compound_interest">
                                    <span class="checkmark"></span>
                                    Juros compostos
                                </label>
                                <small>Se desmarcado, usa juros simples</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Limits -->
                    <div class="form-section">
                        <h4><i class="fas fa-filter"></i> Filtros e Limites</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="minValue">Valor M√≠nimo (R$)</label>
                                <input type="number" id="minValue" name="min_value" step="0.01" placeholder="Ex: 100.00">
                                <small>Deixe vazio para sem limite</small>
                            </div>
                            <div class="form-group">
                                <label for="maxValue">Valor M√°ximo (R$)</label>
                                <input type="number" id="maxValue" name="max_value" step="0.01" placeholder="Ex: 10000.00">
                                <small>Deixe vazio para sem limite</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxDaysCalculation">M√°ximo de Dias para C√°lculo</label>
                                <input type="number" id="maxDaysCalculation" name="max_days_calculation" value="365" min="1">
                                <small>Limite de dias para evitar juros excessivos</small>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ruleActive" name="active" checked>
                                    <span class="checkmark"></span>
                                    Regra ativa
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Entity Filters (Advanced) -->
                    <div class="form-section">
                        <h4><i class="fas fa-building"></i> Filtros Avan√ßados</h4>
                        <div class="form-group">
                            <label for="entityFilter">Entidades Espec√≠ficas</label>
                            <textarea id="entityFilter" name="entity_filter" placeholder="Digite nomes ou CNPJs separados por v√≠rgula&#10;Ex: Empresa ABC, 12.345.678/0001-90"></textarea>
                            <small>Esta regra ser√° aplicada apenas para essas entidades</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeRuleModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveRule(); return false;">
                    <i class="fas fa-save"></i>
                    Salvar Regra
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal" style="display: none;">
        <div class="modal-content small">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar A√ß√£o</h3>
                <button class="modal-close" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeConfirmModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Liquidation Modal -->
    <div class="modal" id="liquidationModal" style="display: none;">
        <div class="modal-content medium">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-stamp"></i>
                    Confirmar Liquida√ß√£o
                </h3>
                <button class="modal-close" onclick="closeLiquidationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="liquidation-summary">
                    <div class="summary-item">
                        <i class="fas fa-list"></i>
                        <div>
                            <strong>Transa√ß√µes Selecionadas</strong>
                            <span id="liquidationTransactionCount">0</span>
                        </div>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-money-bill"></i>
                        <div>
                            <strong>Valor Total</strong>
                            <span id="liquidationTotalValue">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <strong>Per√≠odo</strong>
                            <span id="liquidationPeriod">-</span>
                        </div>
                    </div>
                </div>

                <div class="liquidation-form">
                    <div class="form-group">
                        <label for="liquidationBankAccount">Conta Banc√°ria *</label>
                        <select id="liquidationBankAccount" onchange="validateLiquidationForm()" required>
                            <option value="">Carregando contas banc√°rias...</option>
                        </select>
                        <div class="field-error" id="bankAccountError" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="liquidationPeriodInput">Per√≠odo da Concilia√ß√£o *</label>
                        <input type="month" id="liquidationPeriodInput" onchange="validateLiquidationForm()" required>
                        <small class="field-help">Selecione o m√™s/ano da concilia√ß√£o</small>
                        <div class="field-error" id="periodError" style="display: none;"></div>
                    </div>
                    
                    <!-- Preview das transa√ß√µes selecionadas -->
                    <div class="form-group">
                        <label>Transa√ß√µes Selecionadas</label>
                        <div class="selected-transactions-preview" id="selectedTransactionsPreview">
                            <!-- Ser√° populado via JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="liquidation-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>
                        <strong>Aten√ß√£o:</strong> Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. 
                        As transa√ß√µes selecionadas ser√£o marcadas como liquidadas e 
                        um registro permanente ser√° criado no hist√≥rico.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeLiquidationModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirmLiquidationBtn" onclick="confirmLiquidation()">
                    <i class="fas fa-stamp"></i>
                    Liquidar Transa√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Calculation Tool -->
    <div class="calculator-overlay" id="calculatorOverlay" style="display: none;">
        <div class="calculator-card">
            <div class="calculator-header">
                <h3>
                    <i class="fas fa-calculator"></i>
                    Calculadora de Juros e Multas
                </h3>
                <button class="close-calculator" onclick="hideCalculator()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="calculator-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor Original (R$)</label>
                        <input type="number" id="calcOriginalValue" step="0.01" placeholder="1000.00">
                    </div>
                    <div class="form-group">
                        <label>Data de Vencimento</label>
                        <input type="date" id="calcDueDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data do Pagamento</label>
                        <input type="date" id="calcPaymentDate">
                    </div>
                    <div class="form-group">
                        <label>Nome da Entidade (opcional)</label>
                        <input type="text" id="calcEntityName" placeholder="Ex: Empresa XYZ Ltda">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Regra Espec√≠fica (opcional)</label>
                        <select id="calcRuleSelect">
                            <option value="">Autom√°tica (melhor regra)</option>
                        </select>
                    </div>
                </div>
                <div class="calculator-actions">
                    <button class="btn btn-primary" onclick="calculateCharges()">
                        <i class="fas fa-calculator"></i>
                        Calcular
                    </button>
                    <button class="btn btn-outline" onclick="clearCalculator()">
                        <i class="fas fa-eraser"></i>
                        Limpar
                    </button>
                </div>
            </div>
            <div class="calculation-result" id="calculationResult" style="display: none;">
                <!-- Result will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="streaming-manager.js"></script>
    <script src="script.js"></script>
    <script>
        // Fun√ß√µes de fallback m√≠nimas - apenas para garantir que o modal funcione
        // O billing-rules.js ir√° sobrescrever com as vers√µes completas
        if (!window.showCreateRuleModal) {
            window.showCreateRuleModal = function() {
                console.log('üîì Abrindo modal de nova regra (fallback tempor√°rio)...');
                const modal = document.getElementById('ruleModal');
                if (modal) {
                    modal.style.display = 'flex';
                    const form = document.getElementById('ruleForm');
                    if (form) form.reset();
                } else {
                    alert('Modal n√£o encontrado. Recarregue a p√°gina.');
                }
            };
        }
        
        if (!window.closeRuleModal) {
            window.closeRuleModal = function() {
                const modal = document.getElementById('ruleModal');
                if (modal) modal.style.display = 'none';
            };
        }
        
        // Fun√ß√£o para carregar regras manualmente
        async function loadRulesManually() {
            console.log('üìã Carregando lista de regras...');
            try {
                const response = await fetch('https://holdprintwebbankreconciliation-test.azurewebsites.net/billing-rules');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const rules = result.rules || [];
                    console.log(`‚úÖ ${rules.length} regras carregadas`);
                    
                    // Atualizar contadores
                    const totalCount = rules.length;
                    const activeCount = rules.filter(r => r.active).length;
                    const inactiveCount = totalCount - activeCount;
                    
                    const totalEl = document.getElementById('totalRulesCount');
                    const activeEl = document.getElementById('activeRulesCount');
                    const inactiveEl = document.getElementById('inactiveRulesCount');
                    
                    if (totalEl) totalEl.textContent = totalCount;
                    if (activeEl) activeEl.textContent = activeCount;
                    if (inactiveEl) inactiveEl.textContent = inactiveCount;
                    
                    // Atualizar tabela
                    const tableBody = document.getElementById('rulesTableBody');
                    if (tableBody && rules.length > 0) {
                        tableBody.innerHTML = rules.map(rule => createSimpleRuleRow(rule)).join('');
                    }
                    
                    // Esconder estado vazio se houver regras
                    const emptyState = document.getElementById('rulesEmptyState');
                    if (emptyState && rules.length > 0) {
                        emptyState.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar regras:', error);
            }
        }
        
        // Fun√ß√£o auxiliar para criar linha da tabela
        function createSimpleRuleRow(rule) {
            return `
                <tr>
                    <td>${rule.name || ''}</td>
                    <td>${rule.description || ''}</td>
                    <td>${rule.fine_enabled ? rule.fine_percentage + '%' : 'Desabilitada'}</td>
                    <td>${rule.interest_enabled ? rule.interest_rate + '%' : 'Desabilitado'}</td>
                    <td>R$ ${rule.min_value || 0} - ${rule.max_value || '‚àû'}</td>
                    <td>${rule.priority || 1}</td>
                    <td>${rule.active ? 'Ativa' : 'Inativa'}</td>
                    <td>
                        <button class="btn-action" onclick="alert('Editar dispon√≠vel ap√≥s recarregar a p√°gina')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        }
        
        // Fun√ß√£o para abrir modal de regras
        window.showCreateRuleModal = function() {
            console.log('üìã Abrindo modal de nova regra...');
            const modal = document.getElementById('ruleModal');
            if (modal) {
                modal.style.display = 'flex';
                const form = document.getElementById('promptForm');
                if (form) {
                    form.reset();
                    // Valores padr√£o
                    document.getElementById('promptPriority').value = 1;
                    document.getElementById('promptActive').value = 'true';
                    
                    // Prompt padr√£o de exemplo
                    document.getElementById('promptContent').value = `Ao realizar a concilia√ß√£o banc√°ria, considere que a diferen√ßa entre o valor previsto no sistema e o valor encontrado no extrato banc√°rio pode ser causada pela aplica√ß√£o de multa e/ou juros.

Regras de c√°lculo (exemplo da configura√ß√£o atual):
- Multa: 2,0% do valor principal, aplicada ap√≥s o vencimento, sem dias de car√™ncia.
- Juros: 1,0% ao m√™s (juros simples), aplicados ap√≥s o vencimento, sem dias de car√™ncia.

Instru√ß√µes:
1. Se houver diferen√ßa positiva no valor pago/recebido, verifique se ela √© compat√≠vel com a soma do valor original + multa + juros proporcionais aos dias de atraso.
2. Calcule juros proporcionais usando a f√≥rmula: (valor_principal * taxa_juros / 100) * (dias_atraso / 30)
3. Sempre considerar que multa e juros podem ser cobrados juntos.
4. Informe no resultado da concilia√ß√£o se a diferen√ßa foi explicada por multa/juros e detalhe o c√°lculo realizado.`;
                }
            }
        };
        
        window.closePromptModal = function() {
            const modal = document.getElementById('promptModal');
            if (modal) modal.style.display = 'none';
        };
        
        // Fun√ß√£o para salvar prompts
        window.savePrompt = function() {
            console.log('üíæ Salvando prompt...');
            
            const formData = {
                id: 'prompt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promptName').value.trim(),
                type: document.getElementById('promptType').value,
                priority: parseInt(document.getElementById('promptPriority').value) || 1,
                active: document.getElementById('promptActive').value === 'true',
                content: document.getElementById('promptContent').value.trim(),
                context: document.getElementById('promptContext').value.trim(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // Valida√ß√£o
            if (!formData.name) {
                alert('Nome do prompt √© obrigat√≥rio');
                return;
            }
            
            if (!formData.content) {
                alert('Conte√∫do do prompt √© obrigat√≥rio');
                return;
            }
            
            console.log('üì¶ Dados do prompt:', formData);
            
            try {
                // Recuperar prompts existentes
                let prompts = JSON.parse(localStorage.getItem('reconciliationPrompts') || '[]');
                
                // Adicionar novo prompt
                prompts.push(formData);
                
                // Salvar no localStorage
                localStorage.setItem('reconciliationPrompts', JSON.stringify(prompts));
                
                console.log('‚úÖ Prompt salvo com sucesso!');
                showSuccessNotification(`Prompt "${formData.name}" criado com sucesso!`);
                
                // Fechar modal
                closePromptModal();
                
                // Recarregar lista
                loadPromptsFromLocal();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar prompt:', error);
                alert('Erro ao salvar prompt: ' + error.message);
            }
        };
        
        // Fun√ß√£o para carregar prompts
        window.loadPromptsFromLocal = function() {
            console.log('üìÇ Carregando prompts...');
            
            try {
                const prompts = JSON.parse(localStorage.getItem('reconciliationPrompts') || '[]');
                console.log(`‚úÖ ${prompts.length} prompts carregados`);
                
                // Atualizar contadores
                const totalCount = prompts.length;
                const activeCount = prompts.filter(p => p.active).length;
                const inactiveCount = totalCount - activeCount;
                
                document.getElementById('totalRulesCount').textContent = totalCount;
                document.getElementById('activeRulesCount').textContent = activeCount;
                document.getElementById('inactiveRulesCount').textContent = inactiveCount;
                
                // Atualizar tabela
                const tableBody = document.getElementById('rulesTableBody');
                if (tableBody) {
                    if (prompts.length > 0) {
                        tableBody.innerHTML = prompts.map(prompt => createPromptRow(prompt)).join('');
                        const emptyState = document.getElementById('rulesEmptyState');
                        if (emptyState) emptyState.style.display = 'none';
                    } else {
                        tableBody.innerHTML = '';
                        const emptyState = document.getElementById('rulesEmptyState');
                        if (emptyState) emptyState.style.display = 'block';
                    }
                }
                
                window.currentPrompts = prompts;
                return prompts;
            } catch (error) {
                console.error('Erro ao carregar prompts:', error);
                return [];
            }
        };
        
        // Criar linha da tabela para prompt
        function createPromptRow(prompt) {
            const createdDate = new Date(prompt.created_at).toLocaleDateString('pt-BR');
            const typeLabels = {
                'billing': 'Cobran√ßa',
                'matching': 'Correspond√™ncia',
                'validation': 'Valida√ß√£o',
                'general': 'Geral'
            };
            
            return `
                <tr data-prompt-id="${prompt.id}">
                    <td>
                        <strong>${prompt.name}</strong>
                        <br><small>Criado: ${createdDate}</small>
                    </td>
                    <td>
                        <span class="type-badge" style="background: #e0e7ff; color: #3730a3;">
                            ${typeLabels[prompt.type] || prompt.type}
                        </span>
                    </td>
                    <td title="${prompt.content}">
                        ${prompt.content.substring(0, 100)}...
                    </td>
                    <td>
                        ${prompt.context || 'Sem contexto espec√≠fico'}
                    </td>
                    <td><span class="priority-badge">${prompt.priority}</span></td>
                    <td>${prompt.active ? '<span class="status-badge active">Ativo</span>' : '<span class="status-badge inactive">Inativo</span>'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action edit" onclick="editPrompt('${prompt.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action delete" onclick="deletePrompt('${prompt.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Fun√ß√£o para excluir prompt
        window.deletePrompt = function(promptId) {
            if (confirm('Tem certeza que deseja excluir este prompt?')) {
                const prompts = JSON.parse(localStorage.getItem('reconciliationPrompts') || '[]');
                const filteredPrompts = prompts.filter(p => p.id !== promptId);
                localStorage.setItem('reconciliationPrompts', JSON.stringify(filteredPrompts));
                showSuccessNotification('Prompt exclu√≠do com sucesso!');
                loadPromptsFromLocal();
            }
        };
        
        // Fun√ß√£o para editar prompt (placeholder)
        window.editPrompt = function(promptId) {
            alert('Funcionalidade de edi√ß√£o em desenvolvimento. ID do prompt: ' + promptId);
        };
        
        // Fun√ß√£o para filtrar prompts
        window.filterPrompts = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const prompts = window.currentPrompts || [];
            
            const filtered = prompts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.content.toLowerCase().includes(searchTerm) ||
                p.context.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.getElementById('rulesTableBody');
            if (tableBody) {
                tableBody.innerHTML = filtered.map(prompt => createPromptRow(prompt)).join('');
            }
        };
        
        // Fun√ß√£o antiga de saveRule mantida para compatibilidade
        window.saveRule = function() {
            console.log('üíæ Salvando regra localmente...');
            
            // Coletar dados do formul√°rio
            const formData = {
                name: document.getElementById('ruleName').value.trim(),
                description: document.getElementById('ruleDescription').value.trim(),
                priority: parseInt(document.getElementById('rulePriority').value) || 1,
                
                // Multa
                fine_enabled: document.getElementById('fineEnabled').checked,
                fine_percentage: parseFloat(document.getElementById('finePercentage').value) || 0,
                fine_grace_days: parseInt(document.getElementById('fineGraceDays').value) || 0,
                
                // Juros
                interest_enabled: document.getElementById('interestEnabled').checked,
                interest_rate: parseFloat(document.getElementById('interestRate').value) || 0,
                interest_type: document.getElementById('interestType').value || 'MONTHLY',
                interest_grace_days: parseInt(document.getElementById('interestGraceDays').value) || 0,
                compound_interest: document.getElementById('compoundInterest').checked,
                
                // Limites
                max_days_calculation: parseInt(document.getElementById('maxDaysCalculation').value) || 365,
                active: document.getElementById('ruleActive').checked
            };
            
            // Valores opcionais
            const minValue = parseFloat(document.getElementById('minValue').value);
            if (!isNaN(minValue) && minValue > 0) {
                formData.min_value = minValue;
            }
            
            const maxValue = parseFloat(document.getElementById('maxValue').value);
            if (!isNaN(maxValue) && maxValue > 0) {
                formData.max_value = maxValue;
            }
            
            // Valida√ß√£o b√°sica
            if (!formData.name) {
                alert('Nome da regra √© obrigat√≥rio');
                return;
            }
            
            if (!formData.description) {
                alert('Descri√ß√£o da regra √© obrigat√≥ria');
                return;
            }
            
            // Adicionar metadados
            formData.id = 'rule_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            formData.created_at = new Date().toISOString();
            formData.updated_at = new Date().toISOString();
            
            console.log('üì¶ Dados da regra:', formData);
            
            // Mostrar loading
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            
            try {
                // Recuperar regras existentes do localStorage
                let rules = JSON.parse(localStorage.getItem('billingRules') || '[]');
                
                // Adicionar nova regra
                rules.push(formData);
                
                // Salvar no localStorage
                localStorage.setItem('billingRules', JSON.stringify(rules));
                
                // Salvar tamb√©m um arquivo de backup (simulado)
                const rulesData = {
                    rules: rules,
                    lastUpdated: new Date().toISOString(),
                    totalRules: rules.length
                };
                
                console.log('‚úÖ Regra salva localmente!');
                console.log('üìä Total de regras salvas:', rules.length);
                console.log('üìã Regras atuais:', rules);
                
                // Mostrar notifica√ß√£o de sucesso
                showSuccessNotification(`Regra "${formData.name}" criada com sucesso!`);
                
                // Fechar modal
                const modal = document.getElementById('ruleModal');
                if (modal) modal.style.display = 'none';
                
                // Recarregar lista
                loadRulesFromLocal();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar localmente:', error);
                alert('Erro ao salvar regra: ' + error.message);
            } finally {
                // Esconder loading
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
        };
        
        // Fun√ß√£o para carregar regras do localStorage
        window.loadRulesFromLocal = function() {
            console.log('üìÇ Carregando regras locais...');
            
            try {
                const rules = JSON.parse(localStorage.getItem('billingRules') || '[]');
                console.log(`‚úÖ ${rules.length} regras carregadas do localStorage`);
                
                // Atualizar contadores
                const totalCount = rules.length;
                const activeCount = rules.filter(r => r.active).length;
                const inactiveCount = totalCount - activeCount;
                
                document.getElementById('totalRulesCount').textContent = totalCount;
                document.getElementById('activeRulesCount').textContent = activeCount;
                document.getElementById('inactiveRulesCount').textContent = inactiveCount;
                
                // Atualizar tabela
                const tableBody = document.getElementById('rulesTableBody');
                if (tableBody) {
                    if (rules.length > 0) {
                        tableBody.innerHTML = rules.map(rule => createLocalRuleRow(rule)).join('');
                        document.getElementById('rulesEmptyState').style.display = 'none';
                    } else {
                        tableBody.innerHTML = '';
                        document.getElementById('rulesEmptyState').style.display = 'block';
                    }
                }
                
                // Armazenar regras globalmente para uso posterior
                window.currentLocalRules = rules;
                
                return rules;
            } catch (error) {
                console.error('Erro ao carregar regras locais:', error);
                return [];
            }
        };
        
        // Fun√ß√£o para criar linha da tabela com dados locais
        function createLocalRuleRow(rule) {
            const createdDate = new Date(rule.created_at).toLocaleDateString('pt-BR');
            return `
                <tr data-rule-id="${rule.id}">
                    <td>
                        <strong>${rule.name}</strong>
                        <br><small>Criada: ${createdDate}</small>
                    </td>
                    <td title="${rule.description}">
                        ${rule.description.length > 60 ? rule.description.substring(0, 60) + '...' : rule.description}
                    </td>
                    <td>${rule.fine_enabled ? rule.fine_percentage + '% (' + rule.fine_grace_days + 'd car√™ncia)' : 'Desabilitada'}</td>
                    <td>${rule.interest_enabled ? rule.interest_rate + '% ' + rule.interest_type : 'Desabilitado'}</td>
                    <td>R$ ${rule.min_value || 0} - ${rule.max_value || '‚àû'}</td>
                    <td><span class="priority-badge">${rule.priority}</span></td>
                    <td>${rule.active ? '<span class="status-badge active">Ativa</span>' : '<span class="status-badge inactive">Inativa</span>'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action edit" onclick="editLocalRule('${rule.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action delete" onclick="deleteLocalRule('${rule.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Fun√ß√£o para mostrar notifica√ß√£o de sucesso
        function showSuccessNotification(message) {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Fun√ß√£o para excluir regra local
        window.deleteLocalRule = function(ruleId) {
            if (confirm('Tem certeza que deseja excluir esta regra?')) {
                const rules = JSON.parse(localStorage.getItem('billingRules') || '[]');
                const filteredRules = rules.filter(r => r.id !== ruleId);
                localStorage.setItem('billingRules', JSON.stringify(filteredRules));
                showSuccessNotification('Regra exclu√≠da com sucesso!');
                loadRulesFromLocal();
            }
        };
        
        // Fun√ß√£o para editar regra local (placeholder)
        window.editLocalRule = function(ruleId) {
            alert('Funcionalidade de edi√ß√£o em desenvolvimento. ID da regra: ' + ruleId);
        };
    </script>
    <script src="billing-rules.js"></script>
    <script>
        // Verifica√ß√£o para debug e carregamento inicial
        window.addEventListener('load', function() {
            console.log('üìã Verificando fun√ß√µes carregadas:');
            console.log('  showCreateRuleModal:', typeof window.showCreateRuleModal);
            console.log('  closeRuleModal:', typeof window.closeRuleModal);
            console.log('  saveRule:', typeof window.saveRule);
            console.log('  loadRulesFromLocal:', typeof window.loadRulesFromLocal);
            
            // Carregar regras locais ao iniciar
            console.log('üöÄ Carregando regras salvas localmente...');
            loadRulesFromLocal();
        });
        
        // Adicionar estilos de anima√ß√£o
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
