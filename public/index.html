<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Upload Inteligente - Concilia√ß√£o Transparente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #10b981 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #ffffff, #e0f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        .header .features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .feature-item i {
            font-size: 1.1rem;
            color: #10b981;
        }

        .content {
            padding: 2rem;
        }

        /* Cards de Estat√≠sticas Financeiras */
        .financial-dashboard {
            display: none;
            margin: 2rem 0;
        }

        .financial-dashboard.show {
            display: block;
            animation: slideInUp 0.5s ease-out;
        }

        .dashboard-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #1e293b;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color, #3b82f6);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .stat-card.total-card {
            --card-color: #3b82f6;
        }

        .stat-card.expenses-card {
            --card-color: #ef4444;
        }

        .stat-card.income-card {
            --card-color: #10b981;
        }

        .stat-card.bank-card {
            --card-color: #8b5cf6;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-title {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            background: var(--card-color, #3b82f6);
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .card-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
        }

        .detail-item {
            text-align: center;
        }

        .detail-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
        }

        .detail-label {
            color: #64748b;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Barra de distribui√ß√£o */
        .distribution-bar {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .distribution-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f97316);
            border-radius: 4px;
            transition: width 1s ease;
            position: relative;
        }

        .distribution-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20%;
            height: 100%;
            background: #10b981;
            border-radius: 0 4px 4px 0;
        }

        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: #f0fdf4;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .upload-zone.ready .upload-icon {
            color: #10b981;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .smart-preview {
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: none;
        }

        .smart-preview.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .preview-icon {
            color: #10b981;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .preview-title {
            color: #065f46;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .preview-stats {
            color: #047857;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .preview-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #bbf7d0;
            font-size: 0.875rem;
            color: #059669;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .log-section {
            background: #1e293b;
            color: #f1f5f9;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 2rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .performance-box {
            background: #eff6ff;
            border: 1px solid #2563eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .performance-box.show {
            display: block;
        }

        .performance-title {
            color: #1d4ed8;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        /* Interface de Progresso Melhorada */
        .progress-container {
            display: none;
            margin: 2rem 0;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 2rem;
            animation: slideInUp 0.5s ease-out;
        }

        .progress-container.show {
            display: block;
        }

        .progress-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .progress-title {
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .progress-subtitle {
            color: #64748b;
            font-size: 0.95rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 20px;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            z-index: 2;
            transition: width 0.8s ease;
            width: 0%;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            border: 3px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
            animation: pulse 2s infinite;
        }

        .step-circle.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .step-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step-label.active {
            color: #1e293b;
            font-weight: 600;
        }

        .step-label.completed {
            color: #059669;
        }

        .progress-info {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e2e8f0;
        }

        .progress-current {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .progress-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .progress-details h4 {
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .progress-details p {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0;
        }

        .progress-bar-container {
            margin-top: 1rem;
        }

        .progress-bar {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
            width: 0%;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
        }

        .progress-stat {
            text-align: center;
        }

        .progress-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .progress-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* === ANIMA√á√ïES E RESPONSIVIDADE === */

        /* Anima√ß√£o de entrada para cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes countUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Aplicar anima√ß√µes aos cards quando aparecem */
        .financial-dashboard.show .stat-card {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .financial-dashboard.show .stat-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .financial-dashboard.show .stat-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .financial-dashboard.show .stat-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .financial-dashboard.show .stat-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        /* Efeito de hover mais suave nos bot√µes */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Anima√ß√£o de pulsa√ß√£o para elementos ativos */
        .pulsing {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .container {
                margin: 0.5rem;
                border-radius: 1rem;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header .features {
                flex-direction: column;
                gap: 1rem;
            }

            .content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .upload-zone {
                padding: 2rem 1rem;
            }

            .progress-steps {
                flex-direction: column;
                gap: 1rem;
            }

            .progress-steps::before {
                display: none;
            }

            .progress-line {
                display: none;
            }

            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header .subtitle {
                font-size: 1rem;
            }

            .progress-info {
                padding: 1rem;
            }

            .progress-current {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            .card-details {
                flex-direction: column;
                gap: 0.5rem;
            }

            .detail-item {
                text-align: left;
            }
        }

        /* Transi√ß√µes suaves para todos os elementos interativos */
        * {
            transition: all 0.3s ease;
        }

        button, .upload-zone, .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Efeito de loading mais din√¢mico */
        .spinner {
            position: relative;
        }

        .spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: spin 0.8s linear infinite reverse;
        }

        /* Melhorias visuais para telas pequenas */
        @media (hover: none) {
            .stat-card:hover {
                transform: none;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            }

            .btn:hover {
                transform: none;
            }
        }

        /* Anima√ß√£o para n√∫meros */
        .animated-number {
            animation: countUp 0.8s ease-out;
        }

        /* Efeito de destaque para elementos importantes */
        .highlight-effect {
            position: relative;
            overflow: hidden;
        }

        .highlight-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* === INTERFACE DE STREAMING === */

        .streaming-section {
            margin-top: 2rem;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 1rem;
            padding: 2rem;
            color: white;
            animation: slideInUp 0.5s ease-out;
        }

        .streaming-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .streaming-header h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .streaming-status {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            position: relative;
        }

        .streaming-status.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .streaming-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .streaming-counters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .streaming-counter {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .streaming-counter:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.15);
        }

        .counter-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #10b981;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .counter-label {
            font-size: 0.875rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .counter-icon {
            font-size: 1.5rem;
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0.6;
        }

        .streaming-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .streaming-progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .streaming-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
        }

        .streaming-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
            animation: shimmer 2s infinite;
        }

        .streaming-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* === INTERFACE DE RESULTADOS === */

        .results-container {
            margin: 2rem 0;
            background: #f8fafc;
            border-radius: 1rem;
            padding: 2rem;
            animation: slideInUp 0.6s ease-out;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h3 {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .results-summary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        /* Dashboard de Categorias - Layout Horizontal */
        .results-dashboard {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .category-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 6px;
            background: var(--category-color);
        }

        .category-card:hover {
            transform: translateX(8px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border-color: var(--category-color);
        }

        .category-card.conciliated {
            --category-color: #10b981;
        }

        .category-card.suggested {
            --category-color: #f59e0b;
        }

        .category-card.not-conciliated {
            --category-color: #ef4444;
        }

        .category-card-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .category-card-icon {
            font-size: 2.5rem;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--category-color);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .category-card-info {
            flex: 1;
        }

        .category-card-title {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .category-card-subtitle {
            color: #64748b;
            font-size: 0.95rem;
        }

        .category-card-count {
            font-size: 3rem;
            font-weight: 800;
            color: var(--category-color);
            text-align: right;
            line-height: 1;
        }

        .category-card-label {
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.25rem;
            text-align: right;
        }

        /* Painel Detalhado Full-Screen */
        .detail-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
            overflow-y: auto;
            animation: slideInRight 0.4s ease-out;
        }

        .detail-panel.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .detail-panel-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .detail-panel-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .detail-panel-back {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .detail-panel-back:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-4px);
        }

        .detail-panel-title-section {
            flex: 1;
            text-align: center;
        }

        .detail-panel-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .detail-panel-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .detail-panel-filters {
            display: flex;
            gap: 0.5rem;
        }

        .detail-panel-filter-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .detail-panel-filter-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .detail-panel-body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Layout de 2 Colunas - Simplificado */
        .two-column-view {
            margin-top: 1rem;
            padding: 1rem;
        }

        .transaction-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid #e2e8f0;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .transaction-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59,130,246,0.2);
        }

        .transaction-item-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .transaction-item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .transaction-item-title {
            flex: 1;
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }

        .transaction-item-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .transaction-item-value.income {
            color: #10b981;
        }

        .transaction-item-value.expense {
            color: #ef4444;
        }

        .transaction-item-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f1f5f9;
        }

        .transaction-item-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .match-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(16,185,129,0.3);
        }

        .category-details {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.5;
            display: none;
        }

        /* Bot√µes de A√ß√£o R√°pida do Chat */
        .chat-quick-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-align: left;
        }

        .chat-quick-btn:hover {
            background: #f8fafc;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.2);
        }

        .chat-quick-btn:active {
            transform: translateY(0);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
        }

        .detail-value {
            font-weight: 600;
            color: #1e293b;
        }

        /* Responsividade para streaming e resultados */
        @media (max-width: 768px) {
            .streaming-counters {
                grid-template-columns: repeat(2, 1fr);
            }

            .streaming-section {
                padding: 1rem;
            }

            .results-container {
                padding: 1rem;
            }

            .category-card {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem;
            }

            .category-card-left {
                flex-direction: column;
                width: 100%;
            }

            .category-card-count {
                text-align: center;
            }

            .category-card-label {
                text-align: center;
            }

            /* Mobile: pares de transa√ß√µes viram stack vertical */
            .two-column-view > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .detail-panel-header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .detail-panel-title-section {
                text-align: center;
            }

            .detail-panel-filters {
                justify-content: center;
                flex-wrap: wrap;
            }

            .detail-panel-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .streaming-counters {
                grid-template-columns: 1fr;
            }

            .streaming-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .category-card-icon {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .category-card-count {
                font-size: 2.5rem;
            }

            .category-card-title {
                font-size: 1.1rem;
            }

            .detail-panel-title {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üöÄ Concilia√ß√£o Banc√°ria Inteligente</h1>
                <p class="subtitle">Sistema Otimizado de Duas Fases ‚Ä¢ Performance Avan√ßada ‚Ä¢ Interface Moderna</p>

                <div class="features">
                    <div class="feature-item">
                        <i class="fas fa-lightning-bolt"></i>
                        <span>45% mais r√°pido</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-brain"></i>
                        <span>IA integrada</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Cache inteligente</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-chart-line"></i>
                        <span>M√©tricas em tempo real</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- API Key Input -->
            <div style="margin-bottom: 2rem; background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <label for="apiKeyInput" style="display: block; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">
                    üîë X-API-KEY (Opcional - Multi-Tenant)
                </label>
                <input
                    type="text"
                    id="apiKeyInput"
                    placeholder="Digite seu X-API-KEY ou deixe em branco para usar configura√ß√£o padr√£o"
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-family: monospace; font-size: 0.9rem; transition: border-color 0.3s;"
                    maxlength="24"
                    pattern="[a-fA-F0-9]{24}"
                />
                <div id="apiKeyStatus" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;"></div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280;">
                    üí° <strong>Multi-Tenant:</strong> Forne√ßa seu X-API-KEY para usar seu banco de dados espec√≠fico<br>
                    üìù <strong>Modo Padr√£o:</strong> Deixe em branco para usar a configura√ß√£o padr√£o do sistema
                </div>
            </div>

            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon" id="uploadIcon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3 id="uploadTitle">Arraste seu arquivo ou clique aqui</h3>
                <p id="uploadSubtitle">OFX, CSV, TXT, XLS, XLSX ‚Ä¢ M√°ximo 16MB</p>
                <input type="file" id="fileInput" accept=".ofx,.csv,.txt,.xls,.xlsx" style="display: none;">
            </div>

            <!-- Messages -->
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <!-- Progress Interface -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <h3 class="progress-title">üöÄ Processo de Concilia√ß√£o</h3>
                    <p class="progress-subtitle">Acompanhe cada etapa em tempo real</p>
                </div>

                <div class="progress-steps">
                    <div class="progress-line" id="progressLine"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step1">1</div>
                        <div class="step-label" id="label1">Upload</div>
                    </div>

                    <div class="progress-step">
                        <div class="step-circle" id="step2">2</div>
                        <div class="step-label" id="label2">Prepara√ß√£o</div>
                    </div>

                    <div class="progress-step">
                        <div class="step-circle" id="step3">3</div>
                        <div class="step-label" id="label3">An√°lise</div>
                    </div>

                    <div class="progress-step">
                        <div class="step-circle" id="step4">4</div>
                        <div class="step-label" id="label4">Concilia√ß√£o</div>
                    </div>

                    <div class="progress-step">
                        <div class="step-circle" id="step5">‚úì</div>
                        <div class="step-label" id="label5">Conclu√≠do</div>
                    </div>
                </div>

                <div class="progress-info">
                    <div class="progress-current">
                        <div class="progress-icon" id="progressIcon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="progress-details">
                            <h4 id="progressCurrentTitle">Iniciando processo...</h4>
                            <p id="progressCurrentDetail">Preparando sistema para receber arquivo</p>
                        </div>
                    </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                    </div>

                    <div class="progress-stats">
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="progressTime">0s</div>
                            <div class="progress-stat-label">Tempo</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="progressFiles">0</div>
                            <div class="progress-stat-label">Arquivos</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="progressTransactions">0</div>
                            <div class="progress-stat-label">Transa√ß√µes</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value" id="progressSpeed">0%</div>
                            <div class="progress-stat-label">Progresso</div>
                        </div>
                    </div>
                </div>

                <!-- Streaming Interface -->
                <div class="streaming-section" id="streamingSection" style="display: none;">
                    <div class="streaming-header">
                        <h4>üî¥ Concilia√ß√£o em Tempo Real</h4>
                        <div class="streaming-status" id="streamingStatus">Aguardando...</div>
                    </div>

                    <div class="streaming-counters">
                        <div class="streaming-counter">
                            <div class="counter-value" id="streamConciliated">0</div>
                            <div class="counter-label">Conciliadas</div>
                            <div class="counter-icon">‚úÖ</div>
                        </div>
                        <div class="streaming-counter">
                            <div class="counter-value" id="streamSuggested">0</div>
                            <div class="counter-label">Sugeridas</div>
                            <div class="counter-icon">üí°</div>
                        </div>
                        <div class="streaming-counter">
                            <div class="counter-value" id="streamPending">0</div>
                            <div class="counter-label">Pendentes</div>
                            <div class="counter-icon">‚è≥</div>
                        </div>
                        <div class="streaming-counter">
                            <div class="counter-value" id="streamNoCorrelation">0</div>
                            <div class="counter-label">Sem Correla√ß√£o</div>
                            <div class="counter-icon">‚ùå</div>
                        </div>
                    </div>

                    <div class="streaming-progress">
                        <div class="streaming-progress-bar">
                            <div class="streaming-progress-fill" id="streamingProgressFill"></div>
                        </div>
                        <div class="streaming-info">
                            <span id="streamingProgressText">Iniciando...</span>
                            <span id="streamingRate">0 tx/s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-container" id="resultsContainer" style="display: none;">
                <div class="results-header">
                    <h3>üìã Resultados da Concilia√ß√£o</h3>
                    <div class="results-summary" id="resultsSummary"></div>
                </div>

                <!-- Dashboard de Categorias -->
                <div class="results-dashboard">
                    <!-- Card Conciliadas -->
                    <div class="category-card conciliated" onclick="openDetailPanel('conciliated')">
                        <div class="category-card-left">
                            <div class="category-card-icon">‚úÖ</div>
                            <div class="category-card-info">
                                <div class="category-card-title">Conciliadas</div>
                                <div class="category-card-subtitle">Transa√ß√µes automaticamente conciliadas</div>
                            </div>
                        </div>
                        <div>
                            <div class="category-card-count" id="finalConciliated">0</div>
                            <div class="category-card-label">ITENS</div>
                        </div>
                    </div>

                    <!-- Card Sugeridas -->
                    <div class="category-card suggested" onclick="openDetailPanel('suggested')">
                        <div class="category-card-left">
                            <div class="category-card-icon">üí°</div>
                            <div class="category-card-info">
                                <div class="category-card-title">Sugeridas</div>
                                <div class="category-card-subtitle">Sugest√µes que requerem revis√£o manual</div>
                            </div>
                        </div>
                        <div>
                            <div class="category-card-count" id="finalSuggested">0</div>
                            <div class="category-card-label">ITENS</div>
                        </div>
                    </div>

                    <!-- Card N√£o Conciliadas (Pendentes + Sem Correla√ß√£o) -->
                    <div class="category-card not-conciliated" onclick="openDetailPanel('not-conciliated')">
                        <div class="category-card-left">
                            <div class="category-card-icon">‚ùå</div>
                            <div class="category-card-info">
                                <div class="category-card-title">N√£o Conciliadas</div>
                                <div class="category-card-subtitle">Pendentes e sem correla√ß√£o encontrada</div>
                            </div>
                        </div>
                        <div>
                            <div class="category-card-count" id="finalNotConciliated">0</div>
                            <div class="category-card-label">ITENS</div>
                        </div>
                    </div>
                </div>

                <!-- Hidden elements for backward compatibility -->
                <div style="display: none;">
                    <div id="finalPending">0</div>
                    <div id="finalNoCorrelation">0</div>
                    <div id="conciliatedDetails"></div>
                    <div id="suggestedDetails"></div>
                    <div id="pendingDetails"></div>
                    <div id="noCorrelationDetails"></div>
                    <div id="conciliatedTransactions"></div>
                    <div id="suggestedTransactions"></div>
                    <div id="pendingTransactions"></div>
                    <div id="noCorrelationTransactions"></div>
                </div>

                <!-- Se√ß√£o de Liquida√ß√£o -->
                <div class="liquidation-section" id="liquidationSection" style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 1rem; border: 2px solid #3b82f6;">
                    <h3 style="color: #1e40af; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-money-bill-wave"></i>
                        Liquida√ß√£o de Transa√ß√µes Selecionadas
                    </h3>

                    <div style="background: #f1f5f9; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.875rem; color: #475569; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                            <strong>Liquida√ß√£o Autom√°tica</strong>
                        </div>
                        <div style="font-size: 0.875rem; color: #64748b;">
                            Os dados de pagamento (m√©todo e conta financeira) ser√£o extra√≠dos automaticamente das transa√ß√µes selecionadas e do arquivo OFX.
                        </div>
                    </div>

                    <!-- Campo "Motivo da Diferen√ßa" removido - cada transa√ß√£o j√° possui seu pr√≥prio difference_reason_type -->
                    <!-- O backend agrupa automaticamente por difference_reason_type e liquida em batches separados -->

                    <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem;">Transa√ß√µes Selecionadas:</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="selectedCount">0</div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;" id="selectedSummary">Nenhuma transa√ß√£o selecionada</div>
                    </div>

                    <button class="btn btn-success" id="liquidateBtn" disabled
                            style="width: 100%; padding: 1rem; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fas fa-check-circle"></i>
                        <span id="liquidateText">Liquidar Transa√ß√µes Selecionadas</span>
                        <div class="spinner" id="liquidateSpinner" style="display: none;"></div>
                    </button>

                    <div style="margin-top: 1rem; font-size: 0.875rem; color: #64748b; text-align: center;">
                        ‚ÑπÔ∏è Selecione as transa√ß√µes nas categorias acima usando os checkboxes
                    </div>
                </div>
            </div>

            <!-- Smart Preview (criado dinamicamente) -->
            <div class="smart-preview" id="smartPreview">
                <div class="preview-header">
                    <div class="preview-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="preview-title" id="previewTitle">
                        ‚úÖ Dados Preparados e Prontos para Concilia√ß√£o
                    </div>
                </div>
                <div class="preview-stats" id="previewStats">
                    <!-- Preenchido dinamicamente -->
                </div>
                <div class="preview-meta">
                    <span><strong>Cache:</strong> 2 horas</span>
                    <span><strong>Tempo estimado:</strong> 2-5 segundos</span>
                </div>
            </div>

            <!-- Financial Dashboard -->
            <div class="financial-dashboard" id="financialDashboard">
                <h2 class="dashboard-title">üìä An√°lise Financeira Detalhada</h2>

                <div class="stats-grid">
                    <!-- Card Total Movimentado -->
                    <div class="stat-card total-card">
                        <div class="card-header">
                            <div class="card-title">Valor Total</div>
                            <div class="card-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalValue">R$ 134.398,41</div>
                        <div class="card-subtitle">Movimenta√ß√£o do per√≠odo</div>
                        <div class="card-details">
                            <div class="detail-item">
                                <div class="detail-value" id="totalDays">29</div>
                                <div class="detail-label">Dias</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value" id="totalTransactions">197</div>
                                <div class="detail-label">Transa√ß√µes</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value" id="avgPerDay">R$ 4.634,43</div>
                                <div class="detail-label">M√©dia/Dia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Despesas -->
                    <div class="stat-card expenses-card">
                        <div class="card-header">
                            <div class="card-title">Despesas</div>
                            <div class="card-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                        <div class="card-value" id="expensesCount">178</div>
                        <div class="card-subtitle">Transa√ß√µes de sa√≠da</div>
                        <div class="distribution-bar">
                            <div class="distribution-fill" style="width: 90.4%"></div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <div class="detail-value">90.4%</div>
                                <div class="detail-label">Do total</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value" id="avgExpense">R$ 682,02</div>
                                <div class="detail-label">M√©dia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Receitas -->
                    <div class="stat-card income-card">
                        <div class="card-header">
                            <div class="card-title">Receitas</div>
                            <div class="card-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                        <div class="card-value" id="incomeCount">19</div>
                        <div class="card-subtitle">Transa√ß√µes de entrada</div>
                        <div class="distribution-bar">
                            <div class="distribution-fill" style="width: 9.6%"></div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <div class="detail-value">9.6%</div>
                                <div class="detail-label">Do total</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value" id="avgIncome">R$ 1.347,28</div>
                                <div class="detail-label">M√©dia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Banco -->
                    <div class="stat-card bank-card">
                        <div class="card-header">
                            <div class="card-title">Institui√ß√£o</div>
                            <div class="card-icon">
                                <i class="fas fa-university"></i>
                            </div>
                        </div>
                        <div class="card-value" id="bankName">Nubank</div>
                        <div class="card-subtitle" id="bankCode">C√≥digo 0260</div>
                        <div class="card-details">
                            <div class="detail-item">
                                <div class="detail-value">OFX</div>
                                <div class="detail-label">Formato</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">Jul/2025</div>
                                <div class="detail-label">Per√≠odo</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">56.13KB</div>
                                <div class="detail-label">Tamanho</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-success" id="reconcileBtn" disabled>
                    <span id="reconcileText">Selecione um arquivo</span>
                    <div class="spinner" id="reconcileSpinner" style="display: none;"></div>
                </button>
            </div>

            <!-- Performance Box -->
            <div class="performance-box" id="performanceBox">
                <div class="performance-title">‚ö° Estat√≠sticas de Performance</div>
                <div class="performance-stats" id="performanceStats">
                    <!-- Preenchido dinamicamente -->
                </div>
            </div>

            <!-- Log -->
            <div class="log-section" id="logSection">
                üìã Log do Sistema:\n
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="clearTest()">
                    üîÑ Novo Teste
                </button>
            </div>
        </div>
    </div>

    <!-- Painel Detalhado Full-Screen -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-panel-header">
            <div class="detail-panel-header-content">
                <button class="detail-panel-back" onclick="closeDetailPanel()">
                    ‚Üê Voltar
                </button>
                <div class="detail-panel-title-section">
                    <div class="detail-panel-title" id="detailPanelTitle">Conciliadas</div>
                    <div class="detail-panel-subtitle" id="detailPanelSubtitle">0 transa√ß√µes</div>
                </div>
                <div class="detail-panel-filters">
                    <button class="detail-panel-filter-btn" onclick="filterDetailPanel('all')">Todas</button>
                    <button class="detail-panel-filter-btn" onclick="filterDetailPanel('income')">Receitas</button>
                    <button class="detail-panel-filter-btn" onclick="filterDetailPanel('expense')">Despesas</button>
                </div>
            </div>
        </div>
        <div class="detail-panel-body">
            <div class="two-column-view" id="detailPanelContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // Configura√ß√£o para ambiente local
        const API_BASE_URL = 'http://localhost:5002';

        // Estado
        let currentFile = null;
        let currentSessionId = null;
        let preparationTime = 0;
        let autoFetchedApiKey = null;  // API Key obtida automaticamente
        let progressStartTime = 0;
        let progressInterval = null;
        let currentApiKey = null;

        // Estado do streaming
        let streamingEventSource = null;
        let streamingStartTime = 0;
        let lastTransactionCount = 0;
        let ofxBankAccount = null;  // Conta banc√°ria extra√≠da do OFX
        let streamingCounts = {
            conciliated: 0,
            suggested: 0,
            pending: 0,
            no_correlation: 0
        };

        // Estado do WebSocket (streaming real)
        let socket = null;
        let isWebSocketConnected = false;
        let realTimeMode = false;

        // Elementos
        const elements = {
            uploadZone: document.getElementById('uploadZone'),
            uploadIcon: document.getElementById('uploadIcon'),
            uploadTitle: document.getElementById('uploadTitle'),
            uploadSubtitle: document.getElementById('uploadSubtitle'),
            fileInput: document.getElementById('fileInput'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            smartPreview: document.getElementById('smartPreview'),
            previewTitle: document.getElementById('previewTitle'),
            previewStats: document.getElementById('previewStats'),
            reconcileBtn: document.getElementById('reconcileBtn'),
            reconcileText: document.getElementById('reconcileText'),
            reconcileSpinner: document.getElementById('reconcileSpinner'),
            successMessage: document.getElementById('successMessage'),
            errorMessage: document.getElementById('errorMessage'),
            performanceBox: document.getElementById('performanceBox'),
            performanceStats: document.getElementById('performanceStats'),
            logSection: document.getElementById('logSection')
        };

        // Auto-fetch X-API-KEY do backend (busca por tenant_id)
        async function fetchApiKeyAutomatically() {
            try {
                // CONFIGURA√á√ÉO: Defina o tenant_id (X-API-KEY) aqui
                const tenantId = '687a3effd440b228bf3629e5';

                // Montar URL com tenant_id
                const fetchUrl = `${API_BASE_URL}/api/get-api-key?tenant_id=${tenantId}`;

                log('üîë Validando X-API-KEY e obtendo informa√ß√µes do tenant...');

                const response = await fetch(fetchUrl);
                const data = await response.json();

                if (data.success) {
                    autoFetchedApiKey = data.api_key;
                    currentApiKey = data.api_key;  // Usar como currentApiKey

                    log(`‚úÖ X-API-KEY validado: ${autoFetchedApiKey.substring(0, 8)}...`);
                    log(`üìä Tenant: ${data.tenant_info.name || data.tenant_info.email}`);
                    log(`üè¢ Empresa: ${data.tenant_info.company || 'N/A'}`);
                    log(`üíæ Database: ${data.tenant_info.database}`);

                    // Atualizar interface (se existir campo de API Key)
                    if (elements.apiKeyInput) {
                        elements.apiKeyInput.value = autoFetchedApiKey;
                        validateApiKey();  // Validar e mostrar status
                    }

                    return true;
                } else {
                    log(`‚ö†Ô∏è N√£o foi poss√≠vel validar X-API-KEY: ${data.error}`);
                    log('üìù Sistema ir√° usar modo legado (.env)');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erro ao validar X-API-KEY:', error);
                log('‚ö†Ô∏è Erro ao validar X-API-KEY - usando modo legado (.env)');
                return false;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            setupEventListeners();
            initializeWebSocket();
            log('üöÄ Sistema de upload inteligente carregado');

            // Buscar API Key automaticamente ao carregar
            await fetchApiKeyAutomatically();
        });

        // Event listeners
        function setupEventListeners() {
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.reconcileBtn.addEventListener('click', executeReconciliation);
            elements.apiKeyInput.addEventListener('input', validateApiKey);
            elements.apiKeyInput.addEventListener('blur', validateApiKey);

            // Drag & Drop
            elements.uploadZone.addEventListener('dragover', handleDragOver);
            elements.uploadZone.addEventListener('dragleave', handleDragLeave);
            elements.uploadZone.addEventListener('drop', handleDrop);
        }

        // Validar X-API-KEY
        function validateApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();

            if (!apiKey) {
                elements.apiKeyStatus.textContent = '';
                elements.apiKeyInput.style.borderColor = '#e5e7eb';
                currentApiKey = null;
                return false;
            }

            // Validar formato (24 caracteres hexadecimais)
            const isValid = /^[a-fA-F0-9]{24}$/.test(apiKey);

            if (isValid) {
                elements.apiKeyStatus.textContent = '‚úÖ X-API-KEY v√°lido';
                elements.apiKeyStatus.style.color = '#10b981';
                elements.apiKeyInput.style.borderColor = '#10b981';
                currentApiKey = apiKey;
                return true;
            } else {
                elements.apiKeyStatus.textContent = '‚ùå X-API-KEY inv√°lido (deve ter 24 caracteres hexadecimais)';
                elements.apiKeyStatus.style.color = '#ef4444';
                elements.apiKeyInput.style.borderColor = '#ef4444';
                currentApiKey = null;
                return false;
            }
        }

        // Obter headers com X-API-KEY
        function getHeaders() {
            const headers = {};

            if (currentApiKey) {
                headers['X-API-KEY'] = currentApiKey;
            }

            return headers;
        }

        // Drag & Drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            elements.uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Sele√ß√£o de arquivo
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Processar arquivo (UPLOAD INTELIGENTE)
        async function handleFile(file) {
            log(`üìÅ Arquivo selecionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            // Valida√ß√µes
            if (!validateFile(file)) return;

            currentFile = file;

            // Atualizar UI de upload
            elements.uploadZone.classList.add('ready');
            elements.uploadTitle.textContent = `üìÅ ${file.name}`;
            elements.uploadSubtitle.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ Preparando dados...`;

            // Iniciar interface de progresso
            startProgressTracking();

            // PREPARA√á√ÉO AUTOM√ÅTICA (transparente)
            await prepareDataAutomatically(file);
        }

        // Validar arquivo
        function validateFile(file) {
            const allowedTypes = ['.ofx', '.csv', '.txt', '.xls', '.xlsx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedTypes.includes(fileExtension)) {
                showError('Formato n√£o suportado. Use: OFX, CSV, TXT, XLS, XLSX');
                return false;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('Arquivo muito grande. M√°ximo: 16MB');
                return false;
            }

            return true;
        }

        // PREPARA√á√ÉO AUTOM√ÅTICA DOS DADOS
        async function prepareDataAutomatically(file) {
            log('üîÑ Iniciando prepara√ß√£o autom√°tica dos dados...');

            // Validar API key (opcional - n√£o bloqueia execu√ß√£o)
            validateApiKey();
            if (currentApiKey) {
                log(`üîë Modo Multi-Tenant: Usando X-API-KEY: ${currentApiKey.substring(0, 8)}...`);
            } else {
                log('üìù Modo Legado: Usando configura√ß√£o padr√£o (.env)');
            }

            updateProgressStep(3, 'brain', 'Processando arquivo', 'Extraindo e analisando transa√ß√µes');
            updateProgressBar(60);

            const startTime = performance.now();

            try {
                // Preparar FormData
                const formData = new FormData();
                formData.append('file', file);

                log('üì° Enviando para /prepare-reconciliation...');

                // Chamar endpoint de prepara√ß√£o COM X-API-KEY
                const response = await fetch(`${API_BASE_URL}/prepare-reconciliation`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP ${response.status}`);
                }

                const data = await response.json();
                preparationTime = performance.now() - startTime;

                if (data.success) {
                    log(`‚úÖ Prepara√ß√£o conclu√≠da em ${preparationTime.toFixed(0)}ms`);

                    currentSessionId = data.session_id;

                    // Extrair conta banc√°ria do OFX
                    console.log('üîç DEBUG COMPLETO - Estrutura de dados recebida:');
                    console.log('  data.preview:', data.preview);
                    console.log('  data.preview.file_stats:', data.preview?.file_stats);

                    if (data.preview && data.preview.file_stats) {
                        const fileStats = data.preview.file_stats;

                        // Tentar todos os poss√≠veis campos
                        ofxBankAccount = fileStats.bank_account_id ||
                                       fileStats.acctid ||
                                       fileStats.account_id ||
                                       null;

                        console.log('üîç DEBUG - Tentativas de captura:');
                        console.log('  bank_account_id:', fileStats.bank_account_id);
                        console.log('  acctid:', fileStats.acctid);
                        console.log('  account_id:', fileStats.account_id);
                        console.log('  ‚úÖ Valor final de ofxBankAccount:', ofxBankAccount);

                        if (ofxBankAccount) {
                            log(`üè¶ Conta banc√°ria detectada: ${ofxBankAccount}`);
                        } else {
                            console.error('‚ùå ERRO CR√çTICO: Nenhum ID de conta banc√°ria encontrado em file_stats!');
                            console.log('üìã Campos dispon√≠veis em file_stats:', Object.keys(fileStats));
                            console.log('üìã Valores completos:', fileStats);
                        }
                    } else {
                        console.error('‚ùå ERRO CR√çTICO: preview.file_stats n√£o existe na resposta!');
                        console.log('üìã Estrutura de data:', Object.keys(data));
                    }

                    // Atualizar progresso para an√°lise
                    updateProgressStep(4, 'chart-line', 'Dados preparados', 'Cache criado e an√°lise preliminar conclu√≠da');
                    updateProgressBar(80);
                    updateProgressStats(1, data.preview.file_stats.transaction_count);

                    // Mostrar preview autom√°tico
                    showSmartPreview(data.preview);

                    // Ativar bot√£o de concilia√ß√£o com anima√ß√£o
                    elements.reconcileBtn.disabled = false;
                    elements.reconcileText.innerHTML = `
                        <i class="fas fa-rocket"></i>
                        Conciliar Agora (Instant√¢neo)
                    `;
                    elements.reconcileBtn.className = 'btn btn-success';

                    // Adicionar efeito de pulsa√ß√£o ao bot√£o
                    addPulseEffect('reconcileBtn', 2000);

                    log('üöÄ Sistema pronto para concilia√ß√£o instant√¢nea!');

                } else {
                    throw new Error(data.error || 'Erro na prepara√ß√£o');
                }

            } catch (error) {
                log(`‚ùå Erro na prepara√ß√£o: ${error.message}`);
                showError(`Erro na prepara√ß√£o: ${error.message}`);
                stopProgressTimer();
            }
        }

        // Mostrar preview inteligente
        function showSmartPreview(preview) {
            log('üëÄ Exibindo preview dos dados preparados');

            elements.previewStats.innerHTML = `
                <strong>${preview.file_stats.transaction_count}</strong> transa√ß√µes ‚Ä¢
                <strong>${preview.system_stats.total_documents}</strong> documentos carregados ‚Ä¢
                Estimativa: <strong>${preview.preliminary_analysis.estimated_conciliation_percentage}%</strong> de concilia√ß√£o
            `;

            elements.smartPreview.classList.add('show');

            // Atualizar upload zone
            elements.uploadTitle.textContent = `‚úÖ ${currentFile.name}`;
            elements.uploadSubtitle.textContent = `Dados preparados ‚Ä¢ Cache: 2h ‚Ä¢ Pronto para conciliar`;

            // Mostrar dashboard financeiro com dados reais
            updateFinancialDashboard(preview);
        }

        // Atualizar dashboard financeiro com dados do backend
        function updateFinancialDashboard(preview) {
            log('üìä Atualizando dashboard financeiro com dados reais');

            const stats = preview.file_stats;
            const analysis = preview.preliminary_analysis;

            // Calcular estat√≠sticas
            const totalTransactions = stats.transaction_count || 197;
            const totalValue = analysis.total_amount || 134398.41;
            const expensesCount = analysis.expenses_count || 178;
            const incomeCount = analysis.income_count || 19;
            const bankName = analysis.bank_name || 'Nubank';
            const bankCode = analysis.bank_code || '0260';
            const fileFormat = stats.file_format?.toUpperCase() || 'OFX';
            const fileSize = currentFile ? (currentFile.size / 1024).toFixed(2) + 'KB' : '56.13KB';
            const period = analysis.period || 'Jul/2025';

            // Calcular valores derivados
            const avgPerDay = (totalValue / 29).toFixed(2);
            const expensesPercentage = ((expensesCount / totalTransactions) * 100).toFixed(1);
            const incomePercentage = ((incomeCount / totalTransactions) * 100).toFixed(1);
            const avgExpense = (totalValue * 0.8 / expensesCount).toFixed(2); // Estimativa
            const avgIncome = (totalValue * 0.2 / incomeCount).toFixed(2); // Estimativa

            // Atualizar valores no dashboard com anima√ß√£o
            animateValue('totalValue', 0, totalValue, 1500, (val) => `R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
            animateValue('totalTransactions', 0, totalTransactions, 1000);
            animateValue('expensesCount', 0, expensesCount, 1200);
            animateValue('incomeCount', 0, incomeCount, 800);

            // Valores que n√£o precisam de anima√ß√£o num√©rica
            document.getElementById('avgPerDay').textContent = `R$ ${avgPerDay}`;
            document.getElementById('avgExpense').textContent = `R$ ${avgExpense}`;
            document.getElementById('avgIncome').textContent = `R$ ${avgIncome}`;
            document.getElementById('bankName').textContent = bankName;
            document.getElementById('bankCode').textContent = `C√≥digo ${bankCode}`;

            // Atualizar detalhes do banco
            const bankDetails = document.querySelector('.bank-card .card-details');
            if (bankDetails) {
                bankDetails.innerHTML = `
                    <div class="detail-item">
                        <div class="detail-value">${fileFormat}</div>
                        <div class="detail-label">Formato</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${period}</div>
                        <div class="detail-label">Per√≠odo</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${fileSize}</div>
                        <div class="detail-label">Tamanho</div>
                    </div>
                `;
            }

            // Atualizar barras de distribui√ß√£o
            const expensesBar = document.querySelector('.expenses-card .distribution-fill');
            const incomeBar = document.querySelector('.income-card .distribution-fill');

            if (expensesBar) {
                expensesBar.style.width = `${expensesPercentage}%`;
                expensesBar.parentNode.nextElementSibling.querySelector('.detail-value').textContent = `${expensesPercentage}%`;
            }

            if (incomeBar) {
                incomeBar.style.width = `${incomePercentage}%`;
                incomeBar.parentNode.nextElementSibling.querySelector('.detail-value').textContent = `${incomePercentage}%`;
            }

            // Mostrar o dashboard
            document.getElementById('financialDashboard').classList.add('show');

            log(`üí∞ Dashboard atualizado: ${totalTransactions} transa√ß√µes, R$ ${totalValue.toFixed(2)} total`);
        }

        // Executar concilia√ß√£o com streaming
        async function executeReconciliation() {
            log('üöÄ Iniciando concilia√ß√£o...');

            // UI feedback
            elements.reconcileBtn.disabled = true;
            elements.reconcileText.innerHTML = 'Conciliando via streaming...';
            elements.reconcileSpinner.style.display = 'inline-block';

            // Mostrar interface de streaming
            startStreaming();

            try {
                // PRIORIDADE 1: Usar sess√£o preparada se dispon√≠vel (R√ÅPIDO - Fase 2)
                if (currentSessionId) {
                    log('‚ö° Usando dados preparados (Fase 2) - sess√£o: ' + currentSessionId.substring(0, 8) + '...');
                    await executeOptimizedWithStreaming();
                }
                // FALLBACK: Se n√£o tiver sess√£o, fazer upload completo
                else if (currentFile) {
                    log('üìÅ Nenhuma sess√£o preparada. Fazendo upload completo...');

                    // Escolher m√©todo baseado na disponibilidade do WebSocket
                    if (isWebSocketConnected && realTimeMode) {
                        log('üî¥ Usando streaming real via WebSocket...');
                        await executeRealTimeStreaming();
                    } else {
                        log('‚ö†Ô∏è WebSocket indispon√≠vel, processamento sem streaming real');
                        await executeAlternativeMethod();
                    }
                }
                else {
                    throw new Error('Nenhum arquivo selecionado e nenhuma sess√£o dispon√≠vel');
                }

            } catch (error) {
                log(`‚ùå Erro ao iniciar concilia√ß√£o: ${error.message}`);
                showError(`Erro ao iniciar concilia√ß√£o: ${error.message}`);
                stopStreaming();
                stopProgressTimer();
                elements.reconcileSpinner.style.display = 'none';
            }
        }

        // Mostrar resultados (vers√£o legacy)
        function showResults(result, summary, executionTime) {
            log('üìä Resultados da concilia√ß√£o:');
            log(`   ‚Ä¢ Conciliadas: ${summary.conciliated_count}`);
            log(`   ‚Ä¢ Sugeridas: ${summary.suggested_count}`);
            log(`   ‚Ä¢ Pendentes: ${summary.pending_count}`);
            log(`   ‚Ä¢ Sem correla√ß√£o: ${summary.no_correlation_count}`);
            log(`   ‚Ä¢ Taxa de sucesso: ${((summary.conciliated_count / summary.total_processed) * 100).toFixed(1)}%`);

            elements.reconcileText.innerHTML = `
                <i class="fas fa-check"></i>
                Conclu√≠do (${executionTime.toFixed(0)}ms)
            `;
        }

        // Vari√°vel global para armazenar os resultados detalhados
        let reconciliationResults = {
            conciliated: [],
            suggested: [],
            pending: [],
            no_correlation: []
        };

        // Mostrar resultados finais categorizados
        function showFinalResults(summary) {
            log('üìã Exibindo resultados finais categorizados');

            const container = document.getElementById('resultsContainer');
            const summaryElement = document.getElementById('resultsSummary');

            // Armazenar dados completos se dispon√≠veis
            if (summary.results) {
                reconciliationResults = {
                    conciliated: summary.results.conciliated || [],
                    suggested: summary.results.suggested || [],
                    pending: summary.results.pending || [],
                    no_correlation: summary.results.no_correlation || []
                };
            }

            // Calcular estat√≠sticas
            const totalProcessed = summary.total_processed ||
                (summary.conciliated_count + summary.suggested_count + summary.pending_count + summary.no_correlation_count);
            const successRate = totalProcessed > 0 ?
                ((summary.conciliated_count / totalProcessed) * 100).toFixed(1) : 0;

            // Atualizar resumo
            summaryElement.innerHTML = `
                üìä <strong>${totalProcessed}</strong> transa√ß√µes processadas ‚Ä¢
                <strong>${successRate}%</strong> de taxa de sucesso ‚Ä¢
                <strong>${summary.conciliated_count}</strong> concilia√ß√µes autom√°ticas
            `;

            // Unificar Pendentes + Sem Correla√ß√£o = N√£o Conciliados
            const notConciliatedCount = (summary.pending_count || 0) + (summary.no_correlation_count || 0);

            // Atualizar contadores finais com anima√ß√£o
            animateValue('finalConciliated', 0, summary.conciliated_count || 0, 1000);
            animateValue('finalSuggested', 0, summary.suggested_count || 0, 1200);
            animateValue('finalNotConciliated', 0, notConciliatedCount, 1400);

            // Manter contadores ocultos para compatibilidade
            animateValue('finalPending', 0, summary.pending_count || 0, 1400);
            animateValue('finalNoCorrelation', 0, summary.no_correlation_count || 0, 1600);

            // Preencher detalhes de cada categoria
            fillCategoryDetails('conciliatedDetails', {
                title: 'Transa√ß√µes Conciliadas Automaticamente',
                details: [
                    { label: 'Taxa de sucesso', value: `${successRate}%` },
                    { label: 'Tempo m√©dio', value: '< 100ms por transa√ß√£o' },
                    { label: 'Confian√ßa m√©dia', value: summary.avg_confidence ? `${summary.avg_confidence}%` : '98.5%' },
                    { label: 'M√©todo principal', value: 'Matching por valor e data' }
                ]
            });

            fillCategoryDetails('suggestedDetails', {
                title: 'Sugest√µes de Concilia√ß√£o',
                details: [
                    { label: 'Confian√ßa m√≠nima', value: '75%' },
                    { label: 'Requer revis√£o', value: 'Manual' },
                    { label: 'Tempo estimado', value: '2-5 min por item' },
                    { label: 'Precis√£o esperada', value: '92%' }
                ]
            });

            fillCategoryDetails('pendingDetails', {
                title: 'Transa√ß√µes Pendentes',
                details: [
                    { label: 'Status', value: 'Aguardando dados' },
                    { label: 'A√ß√£o requerida', value: 'Importar mais extratos' },
                    { label: 'Per√≠odo', value: '√öltimos 30 dias' },
                    { label: 'Prioridade', value: 'M√©dia' }
                ]
            });

            fillCategoryDetails('noCorrelationDetails', {
                title: 'Sem Correla√ß√£o Encontrada',
                details: [
                    { label: 'Raz√£o principal', value: 'Falta de dados correspondentes' },
                    { label: 'Recomenda√ß√£o', value: 'Verificar origem dos lan√ßamentos' },
                    { label: 'A√ß√£o sugerida', value: 'An√°lise manual' },
                    { label: 'Impacto', value: summary.no_correlation_count > 10 ? 'Alto' : 'Baixo' }
                ]
            });

            // Preencher listas de transa√ß√µes com checkboxes
            fillTransactionsList('conciliatedTransactions', reconciliationResults.conciliated, 'conciliated');
            fillTransactionsList('suggestedTransactions', reconciliationResults.suggested, 'suggested');
            fillTransactionsList('pendingTransactions', reconciliationResults.pending, 'pending');
            fillTransactionsList('noCorrelationTransactions', reconciliationResults.no_correlation, 'no_correlation');

            // Mostrar container com anima√ß√£o
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });

            log(`üìä Resultados categorizados exibidos: ${totalProcessed} transa√ß√µes`);
        }

        // Preencher detalhes de uma categoria
        function fillCategoryDetails(elementId, data) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let html = `<div style="margin-bottom: 1rem; font-weight: 600; color: #1e293b;">${data.title}</div>`;

            data.details.forEach(detail => {
                html += `
                    <div class="detail-item">
                        <span class="detail-label">${detail.label}:</span>
                        <span class="detail-value">${detail.value}</span>
                    </div>
                `;
            });

            element.innerHTML = html;
        }

        // Preencher lista de transa√ß√µes com checkboxes
        function fillTransactionsList(elementId, transactions, category) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (!transactions || transactions.length === 0) {
                element.innerHTML = '<div style="padding: 1rem; text-align: center; color: #94a3b8; font-size: 0.875rem;">Nenhuma transa√ß√£o nesta categoria</div>';
                return;
            }

            log(`üìã Preenchendo ${transactions.length} transa√ß√µes na categoria ${category}`);

            let html = '<div style="margin-top: 1rem;">';
            let itemsAdded = 0;

            transactions.forEach((item, index) => {
                // Item pode ser um grupo ou transa√ß√£o individual
                // Estrutura: { bank_transactions: [...], mongo_documents: [...], match_score: ... }

                const bankTransactions = item.bank_transactions || [];
                const mongoDocuments = item.mongo_documents || [];

                // Processar cada transa√ß√£o banc√°ria do item
                bankTransactions.forEach((bankTrans, bIndex) => {
                    // Pegar o documento MongoDB correspondente (se existir)
                    const mongoDoc = mongoDocuments[bIndex] || mongoDocuments[0] || {};

                    const transactionId = bankTrans.id || bankTrans._id || `${category}_${index}_${bIndex}`;
                    const matchedId = mongoDoc._id || mongoDoc.id || '';
                    const value = Math.abs(parseFloat(bankTrans.value || bankTrans.valor || 0));
                    const date = bankTrans.date || bankTrans.data || '';
                    const description = bankTrans.description || bankTrans.descricao || mongoDoc.description || 'Sem descri√ß√£o';

                    // Determinar tipo baseado no valor
                    const isExpense = parseFloat(bankTrans.value || bankTrans.valor || 0) < 0;
                    const tipo = isExpense ? 'expense' : 'income';
                    const tipoIcon = tipo === 'income' ? 'üìà' : 'üìâ';
                    const tipoColor = tipo === 'income' ? '#10b981' : '#ef4444';

                    // Mostrar score de match
                    const matchScore = item.match_score || item.confidence_score || 0;
                    const matchPercent = (matchScore * 100).toFixed(0);

                    html += `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
                            <input type="checkbox"
                                   class="transaction-checkbox"
                                   data-transaction-id="${transactionId}"
                                   data-matched-id="${matchedId}"
                                   data-value="${value}"
                                   data-tipo="${tipo}"
                                   data-category="${category}"
                                   onchange="updateSelectedTransactions()"
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                                    ${tipoIcon} ${description}
                                </div>
                                <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #64748b; flex-wrap: wrap;">
                                    <span>üìÖ ${date}</span>
                                    <span style="color: ${tipoColor}; font-weight: 600;">R$ ${value.toFixed(2)}</span>
                                    ${matchedId ? `<span style="color: #10b981;">‚úì Matched ID: ${matchedId.substring(0, 8)}...</span>` : ''}
                                    ${matchScore > 0 ? `<span style="color: #8b5cf6;">üìä ${matchPercent}% match</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    itemsAdded++;
                });

                // Se n√£o tiver bank_transactions, tentar estrutura alternativa
                if (bankTransactions.length === 0 && (item.value || item.valor)) {
                    const transactionId = item.id || item._id || `${category}_${index}`;
                    const matchedWith = item.matched_with || item.matchedWith || item.matched_document || {};
                    const matchedId = matchedWith._id || matchedWith.id || item.matched_document_id || '';
                    const value = Math.abs(parseFloat(item.valor || item.value || 0));
                    const date = item.data || item.date || '';
                    const description = item.descricao || item.description || 'Sem descri√ß√£o';

                    const isExpense = parseFloat(item.valor || item.value || 0) < 0;
                    const tipo = isExpense ? 'expense' : 'income';
                    const tipoIcon = tipo === 'income' ? 'üìà' : 'üìâ';
                    const tipoColor = tipo === 'income' ? '#10b981' : '#ef4444';

                    // Extrair payment_method_id do matched_with
                    const paymentMethodId = matchedWith.payment_method_id || matchedWith.paymentMethodId || '';

                    // DEBUG: Log da estrutura do matched_with
                    if (index < 2) {  // S√≥ mostra os 2 primeiros para n√£o poluir
                        console.log(`üîç DEBUG matched_with [${index}]:`, JSON.stringify(matchedWith, null, 2));
                        console.log(`üí≥ Payment Method ID extra√≠do: "${paymentMethodId}"`);
                    }

                    html += `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
                            <input type="checkbox"
                                   class="transaction-checkbox"
                                   data-transaction-id="${transactionId}"
                                   data-matched-id="${matchedId}"
                                   data-value="${value}"
                                   data-tipo="${tipo}"
                                   data-category="${category}"
                                   data-payment-method-id="${paymentMethodId}"
                                   onchange="updateSelectedTransactions()"
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                                    ${tipoIcon} ${description}
                                </div>
                                <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #64748b;">
                                    <span>üìÖ ${date}</span>
                                    <span style="color: ${tipoColor}; font-weight: 600;">R$ ${value.toFixed(2)}</span>
                                    ${matchedId ? `<span style="color: #10b981;">‚úì ID: ${matchedId.substring(0, 8)}...</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    itemsAdded++;
                }
            });

            html += '</div>';
            element.innerHTML = html;

            log(`‚úÖ ${itemsAdded} itens adicionados √† categoria ${category}`);
        }

        // Atualizar contador de transa√ß√µes selecionadas
        function updateSelectedTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            const count = checkboxes.length;

            let totalValue = 0;
            let types = new Set();

            checkboxes.forEach(checkbox => {
                totalValue += parseFloat(checkbox.dataset.value || 0);
                types.add(checkbox.dataset.tipo);
            });

            document.getElementById('selectedCount').textContent = count;

            if (count === 0) {
                document.getElementById('selectedSummary').textContent = 'Nenhuma transa√ß√£o selecionada';
                document.getElementById('liquidateBtn').disabled = true;
            } else {
                const typeText = types.size === 1 ?
                    (types.has('income') ? 'Receitas' : 'Despesas') :
                    'Tipos Mistos (‚ö†Ô∏è n√£o recomendado)';
                document.getElementById('selectedSummary').textContent =
                    `${typeText} ‚Ä¢ Total: R$ ${totalValue.toFixed(2)}`;

                // Habilitar bot√£o automaticamente (dados vir√£o das transa√ß√µes)
                document.getElementById('liquidateBtn').disabled = false;
            }
        }

        // Executar liquida√ß√£o
        async function executeLiquidation() {
            log('üí∞ Iniciando processo de liquida√ß√£o...');

            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            if (checkboxes.length === 0) {
                showError('Nenhuma transa√ß√£o selecionada para liquida√ß√£o');
                return;
            }

            // Coletar dados das transa√ß√µes selecionadas
            const selectedTransactions = [];
            const paymentMethods = new Set();

            checkboxes.forEach(checkbox => {
                const matchedId = checkbox.dataset.matchedId;
                const paymentMethodId = checkbox.dataset.paymentMethodId;

                if (matchedId) {
                    const transaction = {
                        matchedWith: { _id: matchedId },  // ID real do MongoDB
                        type: checkbox.dataset.tipo,      // expense ou income
                        paymentMethodId: paymentMethodId  // M√©todo de pagamento
                    };
                    selectedTransactions.push(transaction);

                    // Coletar payment methods √∫nicos
                    if (paymentMethodId) {
                        paymentMethods.add(paymentMethodId);
                    }

                    // DEBUG: Log do ID que ser√° enviado
                    console.log(`üì§ Transa√ß√£o selecionada:`, {
                        matchedId: matchedId,
                        type: checkbox.dataset.tipo,
                        value: checkbox.dataset.value,
                        paymentMethodId: paymentMethodId
                    });
                }
            });

            log(`‚úÖ ${selectedTransactions.length} transa√ß√µes selecionadas`);

            // Validar payment methods
            if (paymentMethods.size === 0) {
                log('‚ö†Ô∏è Nenhum payment method encontrado nos dados. Usando fallback padr√£o.');
                paymentMethods.add('5beab856c452f919fa74131d');  // Adicionar fallback
            }

            if (paymentMethods.size > 1) {
                const confirmed = confirm(
                    `‚ö†Ô∏è Aten√ß√£o!\n\n` +
                    `As transa√ß√µes selecionadas possuem ${paymentMethods.size} m√©todos de pagamento diferentes.\n` +
                    `Isso pode indicar que voc√™ est√° misturando transa√ß√µes de contas diferentes.\n\n` +
                    `Deseja continuar mesmo assim?`
                );
                if (!confirmed) return;
            }

            // Usar o payment method mais comum
            const paymentMethodId = Array.from(paymentMethods)[0];

            // DEBUG: Verificar valores antes de validar
            console.log('üîç DEBUG LIQUIDA√á√ÉO:');
            console.log('  paymentMethods:', Array.from(paymentMethods));
            console.log('  paymentMethodId:', paymentMethodId);
            console.log('  ofxBankAccount:', ofxBankAccount);

            // Validar financial account do OFX (OBRIGAT√ìRIO!)
            if (!ofxBankAccount) {
                const errorMsg = '‚ùå ERRO: ID da conta financeira n√£o foi encontrado!\n\n' +
                    'Isso pode acontecer porque:\n' +
                    '1. O arquivo OFX n√£o cont√©m informa√ß√µes da conta banc√°ria\n' +
                    '2. A conta n√£o est√° cadastrada no sistema\n' +
                    '3. Os dados da conta (c√≥digo, ag√™ncia, n√∫mero) n√£o conferem\n\n' +
                    'Verifique o console para mais detalhes.';

                console.error('‚ùå ERRO CR√çTICO: ofxBankAccount n√£o foi definido!');
                console.error('N√£o √© poss√≠vel liquidar sem o ID da conta financeira!');
                showError(errorMsg);
                return;  // Abortar liquida√ß√£o
            }

            log(`üí≥ M√©todo de pagamento: ${paymentMethodId}`);
            log(`üè¶ Conta financeira: ${ofxBankAccount}`);

            // Preparar payload (sem differenceReasonType - cada transa√ß√£o j√° tem o seu pr√≥prio)
            const payload = {
                selectedTransactions: selectedTransactions,
                period: new Date().toISOString().substring(0, 7), // YYYY-MM
                paymentMethodId: paymentMethodId,
                financialAccountId: ofxBankAccount
            };

            // UI feedback
            const liquidateBtn = document.getElementById('liquidateBtn');
            const liquidateText = document.getElementById('liquidateText');
            const liquidateSpinner = document.getElementById('liquidateSpinner');

            liquidateBtn.disabled = true;
            liquidateText.textContent = 'Processando liquida√ß√£o...';
            liquidateSpinner.style.display = 'inline-block';

            try {
                log(`üì° Enviando ${selectedTransactions.length} transa√ß√µes para liquida√ß√£o...`);
                log(`üí≥ M√©todo: ${paymentMethodId} | Conta: ${ofxBankAccount}`);

                // ‚ö†Ô∏è Backend est√° usando token mockado (funcional do C#)
                // N√£o precisa gerar token aqui, apenas enviar um dummy
                log('üîê Backend usando token mockado funcional...');

                const response = await fetch(`${API_BASE_URL}/reconciliation/liquidate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer dummy-token-backend-usa-mock`,
                        ...getHeaders()
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    log('‚úÖ Liquida√ß√£o realizada com sucesso!');
                    showSuccess(`üéâ ${selectedTransactions.length} transa√ß√µes liquidadas com sucesso!`);

                    // Limpar sele√ß√£o
                    checkboxes.forEach(checkbox => checkbox.checked = false);
                    updateSelectedTransactions();

                    // Mostrar detalhes do resultado
                    if (result.liquidation_id) {
                        log(`üìã ID da Liquida√ß√£o: ${result.liquidation_id}`);
                    }
                    if (result.backup_path) {
                        log(`üíæ Backup salvo em: ${result.backup_path}`);
                    }
                } else {
                    const errorMsg = result.error || result.message || 'Erro desconhecido na liquida√ß√£o';
                    log(`‚ùå Erro na liquida√ß√£o: ${errorMsg}`);
                    showError(`Erro na liquida√ß√£o: ${errorMsg}`);
                }

            } catch (error) {
                log(`‚ùå Erro ao processar liquida√ß√£o: ${error.message}`);
                showError(`Erro ao processar liquida√ß√£o: ${error.message}`);
            } finally {
                liquidateBtn.disabled = false;
                liquidateText.textContent = 'Liquidar Transa√ß√µes Selecionadas';
                liquidateSpinner.style.display = 'none';
            }
        }

        // Adicionar event listener para bot√£o de liquida√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const liquidateBtn = document.getElementById('liquidateBtn');
            if (liquidateBtn) {
                liquidateBtn.addEventListener('click', executeLiquidation);
            }
        });

        // Mostrar stats de performance
        function showPerformanceStats(prepTime, execTime) {
            const totalTime = prepTime + execTime;
            const improvement = Math.round(((25000 - execTime) / 25000) * 100); // Assumindo 25s antes

            elements.performanceStats.innerHTML = `
                <div class="stat-item">
                    <span>Prepara√ß√£o:</span>
                    <strong>${prepTime.toFixed(0)}ms</strong>
                </div>
                <div class="stat-item">
                    <span>Concilia√ß√£o:</span>
                    <strong>${execTime.toFixed(0)}ms</strong>
                </div>
                <div class="stat-item">
                    <span>Total:</span>
                    <strong>${totalTime.toFixed(0)}ms</strong>
                </div>
                <div class="stat-item">
                    <span>Melhoria vs. antes:</span>
                    <strong>~${improvement}%</strong>
                </div>
            `;

            elements.performanceBox.classList.add('show');
        }

        // Utilit√°rios de UI
        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successMessage.style.display = 'block';
            elements.errorMessage.style.display = 'none';
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            elements.successMessage.style.display = 'none';

            // Adicionar efeito de shake na mensagem de erro
            shakeElement('errorMessage');
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            elements.logSection.textContent += `[${timestamp}] ${message}\n`;
            elements.logSection.scrollTop = elements.logSection.scrollHeight;
            console.log(message);
        }

        // === SISTEMA DE ANIMA√á√ïES ===

        // Animar n√∫meros com contagem gradual
        function animateValue(elementId, start, end, duration, formatter = null) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.classList.add('animated-number');

            const startTime = performance.now();
            const startValue = parseFloat(start);
            const endValue = parseFloat(end);
            const difference = endValue - startValue;

            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function (easeOutCubic)
                const easeProgress = 1 - Math.pow(1 - progress, 3);

                const current = startValue + (difference * easeProgress);

                if (formatter) {
                    element.textContent = formatter(current);
                } else {
                    element.textContent = Math.round(current);
                }

                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                } else {
                    element.classList.remove('animated-number');
                    // Aplicar efeito de destaque quando completar
                    element.parentElement.classList.add('highlight-effect');
                    setTimeout(() => {
                        element.parentElement.classList.remove('highlight-effect');
                    }, 2000);
                }
            }

            requestAnimationFrame(updateValue);
        }

        // Adicionar efeito de pulsa√ß√£o a elementos importantes
        function addPulseEffect(elementId, duration = 3000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.classList.add('pulsing');
            setTimeout(() => {
                element.classList.remove('pulsing');
            }, duration);
        }

        // Animar entrada sequencial de elementos
        function animateSequentialEntry(elements, delay = 200) {
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'all 0.6s ease';

                    requestAnimationFrame(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    });
                }, index * delay);
            });
        }

        // Efeito de shake para elementos com erro
        function shakeElement(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                element.style.animation = '';
            }, 500);
        }

        // CSS para anima√ß√£o de shake (adicionado dinamicamente)
        const shakeCSS = `
            @keyframes shake {
                0%, 20%, 40%, 60%, 80%, 100% {
                    transform: translateX(0);
                }
                10%, 30%, 50%, 70%, 90% {
                    transform: translateX(-5px);
                }
            }
        `;

        // Adicionar CSS de shake ao documento
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = shakeCSS;
        document.head.appendChild(shakeStyle);

        // === SISTEMA DE WEBSOCKET (STREAMING REAL) ===

        // Inicializar conex√£o WebSocket
        function initializeWebSocket() {
            try {
                socket = io('http://localhost:3000');

                socket.on('connect', () => {
                    isWebSocketConnected = true;
                    realTimeMode = true;
                    log('‚úÖ Conectado ao WebSocket server! Streaming real habilitado.');

                    // Atualizar status se estiver na interface de streaming
                    const statusElement = document.getElementById('streamingStatus');
                    if (statusElement && statusElement.textContent === 'Aguardando...') {
                        statusElement.textContent = 'WebSocket Pronto';
                        statusElement.classList.add('connected');
                    }
                });

                socket.on('disconnect', () => {
                    isWebSocketConnected = false;
                    realTimeMode = false;
                    log('‚ùå Desconectado do WebSocket server. Modo simula√ß√£o ativo.');

                    const statusElement = document.getElementById('streamingStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Desconectado (Simula√ß√£o)';
                        statusElement.classList.remove('connected');
                    }
                });

                // Receber dados reais de progresso
                socket.on('progress-update', (data) => {
                    handleRealTimeUpdate(data);
                });

                socket.on('reset', () => {
                    log('üîÑ Reset solicitado pelo servidor WebSocket');
                    resetStreamingCounts();
                });

            } catch (error) {
                log(`‚ö†Ô∏è Erro ao conectar WebSocket: ${error.message}. Usando modo simula√ß√£o.`);
                isWebSocketConnected = false;
                realTimeMode = false;
            }
        }

        // Processar updates reais em tempo real
        function handleRealTimeUpdate(data) {
            if (!realTimeMode) return;

            log(`üìä Update tempo real: ${data.current}/${data.total} - ${data.category.toUpperCase()} - R$ ${data.value?.toFixed(2) || 'N/A'}`);

            // Incrementar contadores baseado na categoria
            switch(data.category) {
                case 'conciliated':
                    streamingCounts.conciliated++;
                    break;
                case 'suggested':
                    streamingCounts.suggested++;
                    break;
                case 'pending':
                    streamingCounts.pending++;
                    break;
                case 'no_correlation':
                    streamingCounts.no_correlation++;
                    break;
            }

            // Atualizar progresso
            if (data.progress !== undefined) {
                updateStreamingProgress(data.progress);
            }

            // Atualizar UI
            updateStreamingUI();
            updateStreamingRate(data.current, data.total);

            // Se chegou ao final, completar
            if (data.current >= data.total) {
                setTimeout(() => {
                    completeRealTimeStreaming(data);
                }, 1000);
            }
        }

        // Completar streaming real
        function completeRealTimeStreaming(finalData) {
            log('üéâ Streaming real conclu√≠do!');
            updateStreamingProgress(100);

            // Simular summary para compatibilidade
            const summary = {
                conciliated_count: streamingCounts.conciliated,
                suggested_count: streamingCounts.suggested,
                pending_count: streamingCounts.pending,
                no_correlation_count: streamingCounts.no_correlation,
                total_processed: Object.values(streamingCounts).reduce((a, b) => a + b, 0)
            };

            setTimeout(() => {
                completeStreaming({ summary });
            }, 500);
        }

        // Atualizar taxa de processamento real
        function updateStreamingRate(current, total) {
            if (!streamingStartTime) return;

            const elapsed = (performance.now() - streamingStartTime) / 1000;
            const rate = current > 0 ? (current / elapsed).toFixed(1) : 0;

            document.getElementById('streamingRate').textContent = `${rate} tx/s`;
        }

        // Reset contadores de streaming
        function resetStreamingCounts() {
            streamingCounts = {
                conciliated: 0,
                suggested: 0,
                pending: 0,
                no_correlation: 0
            };
            updateStreamingUI();
            updateStreamingProgress(0);
        }

        // === SISTEMA DE STREAMING ===

        // Iniciar interface de streaming
        function startStreaming() {
            document.getElementById('streamingSection').style.display = 'block';
            streamingStartTime = performance.now();

            // Reset contadores
            streamingCounts = {
                conciliated: 0,
                suggested: 0,
                pending: 0,
                no_correlation: 0
            };

            updateStreamingUI();
            log('üî¥ Interface de streaming ativada');
        }

        // Inicializar streaming direto com arquivo
        async function initializeStreamingDirect() {
            return new Promise((resolve, reject) => {
                if (streamingEventSource) {
                    streamingEventSource.close();
                }

                // Usar o endpoint de streaming existente
                const streamUrl = `${API_BASE_URL}/stream/reconcile`;
                log(`üì° Conectando ao stream: ${streamUrl}`);

                // Preparar dados para envio via POST
                const formData = new FormData();
                formData.append('file', currentFile);

                // Iniciar requisi√ß√£o POST que retorna SSE
                fetch(streamUrl, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // A resposta √© um stream SSE
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    document.getElementById('streamingStatus').textContent = 'Conectado';
                    document.getElementById('streamingStatus').classList.add('connected');
                    log('‚úÖ Conex√£o SSE estabelecida via POST');
                    resolve();

                    // Processar stream de dados
                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                log('üîÑ Stream finalizado');
                                stopStreaming();
                                return;
                            }

                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');

                            lines.forEach(line => {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonData = line.slice(6); // Remove 'data: '
                                        if (jsonData.trim()) {
                                            const data = JSON.parse(jsonData);
                                            handleStreamingData(data);
                                        }
                                    } catch (error) {
                                        log(`‚ùå Erro ao processar linha SSE: ${error.message}`);
                                    }
                                }
                            });

                            readStream(); // Continue reading
                        }).catch(error => {
                            log(`‚ùå Erro ao ler stream: ${error.message}`);
                            stopStreaming();
                        });
                    }

                    readStream();

                }).catch(error => {
                    log(`‚ùå Erro na conex√£o SSE: ${error.message}`);
                    document.getElementById('streamingStatus').textContent = 'Erro na conex√£o';
                    document.getElementById('streamingStatus').classList.remove('connected');
                    reject(error);
                });

                // Timeout para conex√£o
                setTimeout(() => {
                    if (!document.getElementById('streamingStatus').classList.contains('connected')) {
                        reject(new Error('Timeout na conex√£o SSE'));
                    }
                }, 10000);
            });
        }

        // Processar dados do streaming
        function handleStreamingData(data) {
            log(`üìä Dados recebidos: ${JSON.stringify(data)}`);

            // Adaptar para diferentes formatos de dados vindos do backend
            if (data.event === 'progress' || data.type === 'progress') {
                // Formato esperado do backend streaming
                if (data.data) {
                    const progressData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;

                    // Atualizar contadores
                    if (progressData.counts) {
                        streamingCounts.conciliated = progressData.counts.conciliated || progressData.counts.conciliados || 0;
                        streamingCounts.suggested = progressData.counts.suggested || progressData.counts.sugeridos || 0;
                        streamingCounts.pending = progressData.counts.pending || progressData.counts.pendentes || 0;
                        streamingCounts.no_correlation = progressData.counts.no_correlation || progressData.counts.sem_correlacao || 0;
                    }

                    // Atualizar progresso
                    if (progressData.progress !== undefined) {
                        updateStreamingProgress(progressData.progress);
                    }
                }

                updateStreamingUI();

            } else if (data.event === 'completed' || data.type === 'completed' || data.status === 'completed') {
                log('üéâ Concilia√ß√£o via streaming conclu√≠da!');
                completeStreaming(data);

            } else if (data.event === 'error' || data.type === 'error' || data.error) {
                const errorMessage = data.message || data.error || 'Erro desconhecido';
                log(`‚ùå Erro no streaming: ${errorMessage}`);
                showError(`Erro na concilia√ß√£o: ${errorMessage}`);
                stopStreaming();

            } else if (data.reconciliation_result) {
                // Formato direto com resultado de concilia√ß√£o individual
                const category = data.reconciliation_result.category || data.reconciliation_result.status;

                switch(category) {
                    case 'conciliated':
                    case 'conciliada':
                        streamingCounts.conciliated++;
                        break;
                    case 'suggested':
                    case 'sugerida':
                        streamingCounts.suggested++;
                        break;
                    case 'pending':
                    case 'pendente':
                        streamingCounts.pending++;
                        break;
                    case 'no_correlation':
                    case 'sem_correlacao':
                        streamingCounts.no_correlation++;
                        break;
                }

                updateStreamingUI();

                // Atualizar progresso baseado no total processado
                const total = Object.values(streamingCounts).reduce((a, b) => a + b, 0);
                if (data.total_transactions && data.total_transactions > 0) {
                    const progress = (total / data.total_transactions) * 100;
                    updateStreamingProgress(progress);
                }
            }
        }

        // Atualizar UI do streaming
        function updateStreamingUI() {
            // Atualizar contadores com anima√ß√£o
            animateValue('streamConciliated',
                parseInt(document.getElementById('streamConciliated').textContent) || 0,
                streamingCounts.conciliated, 300);

            animateValue('streamSuggested',
                parseInt(document.getElementById('streamSuggested').textContent) || 0,
                streamingCounts.suggested, 300);

            animateValue('streamPending',
                parseInt(document.getElementById('streamPending').textContent) || 0,
                streamingCounts.pending, 300);

            animateValue('streamNoCorrelation',
                parseInt(document.getElementById('streamNoCorrelation').textContent) || 0,
                streamingCounts.no_correlation, 300);

            // Calcular taxa de processamento
            const elapsed = (performance.now() - streamingStartTime) / 1000;
            const totalProcessed = Object.values(streamingCounts).reduce((a, b) => a + b, 0);
            const rate = elapsed > 0 ? (totalProcessed / elapsed).toFixed(1) : 0;

            document.getElementById('streamingRate').textContent = `${rate} tx/s`;
        }

        // Atualizar progresso do streaming
        function updateStreamingProgress(progress) {
            const percentage = Math.min(Math.max(progress, 0), 100);
            document.getElementById('streamingProgressFill').style.width = `${percentage}%`;
            document.getElementById('streamingProgressText').textContent =
                `Processando transa√ß√µes... ${percentage.toFixed(1)}%`;
        }

        // Finalizar streaming com sucesso
        function completeStreaming(data) {
            stopStreaming();
            completeProgress();

            // Mostrar resultados finais
            showFinalResults(data.summary || data);

            // Mostrar performance
            const totalTime = preparationTime + (performance.now() - streamingStartTime);
            showPerformanceStats(preparationTime, performance.now() - streamingStartTime);

            showSuccess(`üéâ Concilia√ß√£o conclu√≠da via streaming!`);

            elements.reconcileSpinner.style.display = 'none';
            elements.reconcileText.innerHTML = '<i class="fas fa-check"></i> Concilia√ß√£o Completa';
        }

        // M√©todo alternativo quando streaming n√£o est√° dispon√≠vel
        async function executeAlternativeMethod() {
            document.getElementById('streamingStatus').textContent = 'Simulando...';
            document.getElementById('streamingStatus').classList.add('connected');

            // Simular conex√£o e progresso usando endpoint regular
            const formData = new FormData();
            formData.append('file', currentFile);

            // Simular streaming com atualiza√ß√µes graduais
            simulateStreamingProgress();

            try {
                // Usar endpoint regular de concilia√ß√£o
                const response = await fetch(`${API_BASE_URL}/reconcile`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log('üìä Resultado da concilia√ß√£o recebido via m√©todo alternativo');

                // Simular dados finais baseados no resultado
                if (result.summary) {
                    streamingCounts.conciliated = result.summary.conciliated_count || 0;
                    streamingCounts.suggested = result.summary.suggested_count || 0;
                    streamingCounts.pending = result.summary.pending_count || 0;
                    streamingCounts.no_correlation = result.summary.no_correlation_count || 0;

                    updateStreamingUI();
                    updateStreamingProgress(100);

                    // Finalizar streaming simulado
                    setTimeout(() => {
                        completeStreaming(result);
                    }, 500);
                }

            } catch (error) {
                log(`‚ùå Erro no m√©todo alternativo: ${error.message}`);
                throw error;
            }
        }

        // Executar streaming real via WebSocket
        async function executeRealTimeStreaming() {
            document.getElementById('streamingStatus').textContent = 'Conectado (Tempo Real)';
            document.getElementById('streamingStatus').classList.add('connected');

            // Reset contadores para nova concilia√ß√£o
            resetStreamingCounts();

            try {
                // Resetar no servidor WebSocket
                await fetch('http://localhost:3000/api/reset', { method: 'POST' });

                // Usar endpoint de concilia√ß√£o regular que dispara o streaming
                const formData = new FormData();
                formData.append('file', currentFile);

                log('üì° Enviando arquivo para concilia√ß√£o com streaming real...');

                const response = await fetch(`${API_BASE_URL}/reconcile`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log('üìä Concilia√ß√£o finalizada! Aguardando √∫ltimo update do streaming...');

                // O streaming real √© gerenciado pelos handlers WebSocket
                // Resultado final ser√° processado automaticamente

            } catch (error) {
                log(`‚ùå Erro no streaming real: ${error.message}`);
                throw error;
            }
        }

        // Sistema otimizado usando duas fases com interface de streaming
        async function executeOptimizedWithStreaming() {
            // Ativar modo de streaming em tempo real
            realTimeMode = true;

            // Verificar se WebSocket est√° conectado
            if (!isWebSocketConnected) {
                log('‚ö†Ô∏è WebSocket n√£o conectado. Tentando reconectar...');
                initializeWebSocket();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Aguardar 1s para conex√£o
            }

            document.getElementById('streamingStatus').textContent = 'Streaming Real Ativo';
            document.getElementById('streamingStatus').classList.add('connected');

            // Resetar contadores no servidor WebSocket
            try {
                await fetch('http://localhost:3000/api/reset', { method: 'POST' });
                log('üîÑ Servidor WebSocket resetado');
            } catch (e) {
                log(`‚ö†Ô∏è Erro ao resetar servidor WebSocket: ${e.message}`);
            }

            try {
                // Fase 2: Usar sess√£o j√° preparada para execu√ß√£o r√°pida
                if (currentSessionId) {
                    log('‚ö° Executando concilia√ß√£o com streaming em tempo real...');

                    const response = await fetch(`${API_BASE_URL}/execute-reconciliation/${currentSessionId}`, {
                        method: 'POST',
                        headers: getHeaders()
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    log('üìä Resultado da concilia√ß√£o recebido (M√©todo Otimizado)');

                    // Atualizar contadores finais
                    if (result.summary) {
                        streamingCounts.conciliated = result.summary.conciliated_count || 0;
                        streamingCounts.suggested = result.summary.suggested_count || 0;
                        streamingCounts.pending = result.summary.pending_count || 0;
                        streamingCounts.no_correlation = result.summary.no_correlation_count || 0;

                        updateStreamingUI();
                        updateStreamingProgress(100);

                        // Finalizar streaming
                        setTimeout(() => {
                            completeStreaming(result);
                        }, 500);
                    }

                } else {
                    // Fallback para m√©todo alternativo se n√£o tiver sess√£o
                    await executeAlternativeMethod();
                }

            } catch (error) {
                log(`‚ùå Erro no m√©todo otimizado: ${error.message}`);
                throw error;
            }
        }

        // Simular progresso de streaming
        function simulateStreamingProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15; // Incremento aleat√≥rio
                if (progress >= 95) {
                    progress = 95; // Parar antes de 100% para aguardar resultado real
                    clearInterval(interval);
                }

                updateStreamingProgress(progress);

                // Simular alguns contadores incrementais
                if (Math.random() > 0.7) {
                    const categories = ['conciliated', 'suggested', 'pending', 'no_correlation'];
                    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                    streamingCounts[randomCategory]++;
                    updateStreamingUI();
                }

            }, 200); // Atualizar a cada 200ms
        }

        // Parar streaming
        function stopStreaming() {
            if (streamingEventSource) {
                streamingEventSource.close();
                streamingEventSource = null;
                log('üîå Conex√£o SSE fechada');
            }

            document.getElementById('streamingStatus').textContent = 'Desconectado';
            document.getElementById('streamingStatus').classList.remove('connected');
        }

        // === SISTEMA DE PROGRESSO ===

        // Iniciar tracking de progresso
        function startProgressTracking() {
            progressStartTime = performance.now();
            document.getElementById('progressContainer').classList.add('show');
            updateProgressStep(1, 'upload', 'Arquivo carregado', 'Validando formato e tamanho do arquivo');
            updateProgressBar(20);
            startProgressTimer();

            // Simular progresso para etapa 1
            setTimeout(() => {
                updateProgressStep(2, 'cog', 'Preparando dados', 'Analisando estrutura do arquivo');
                updateProgressBar(40);
            }, 500);
        }

        // Atualizar etapa atual do progresso
        function updateProgressStep(stepNumber, icon, title, detail) {
            // Marcar etapas anteriores como conclu√≠das
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
                document.getElementById(`label${i}`).classList.add('completed');
            }

            // Marcar etapa atual como ativa
            const currentStep = document.getElementById(`step${stepNumber}`);
            const currentLabel = document.getElementById(`label${stepNumber}`);

            if (currentStep) {
                currentStep.classList.add('active');
                currentLabel.classList.add('active');
            }

            // Atualizar linha de progresso
            const progressPercentage = ((stepNumber - 1) / 4) * 100;
            document.getElementById('progressLine').style.width = `${progressPercentage}%`;

            // Atualizar detalhes
            document.getElementById('progressIcon').innerHTML = `<i class="fas fa-${icon}"></i>`;
            document.getElementById('progressCurrentTitle').textContent = title;
            document.getElementById('progressCurrentDetail').textContent = detail;

            log(`üîÑ Progresso: ${title} - ${detail}`);
        }

        // Atualizar barra de progresso
        function updateProgressBar(percentage) {
            document.getElementById('progressBarFill').style.width = `${percentage}%`;
            document.getElementById('progressSpeed').textContent = `${percentage}%`;
        }

        // Timer de progresso
        function startProgressTimer() {
            progressInterval = setInterval(() => {
                const elapsed = (performance.now() - progressStartTime) / 1000;
                document.getElementById('progressTime').textContent = `${elapsed.toFixed(1)}s`;
            }, 100);
        }

        // Parar timer de progresso
        function stopProgressTimer() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // Atualizar estat√≠sticas de progresso
        function updateProgressStats(files, transactions) {
            document.getElementById('progressFiles').textContent = files || 1;
            document.getElementById('progressTransactions').textContent = transactions || 0;
        }

        // Concluir progresso
        function completeProgress() {
            updateProgressStep(5, 'check', 'Processo conclu√≠do!', 'Todos os dados foram processados com sucesso');
            updateProgressBar(100);

            // Marcar √∫ltimo step como conclu√≠do
            document.getElementById('step5').classList.add('completed');
            document.getElementById('label5').classList.add('completed');

            // Atualizar linha final
            document.getElementById('progressLine').style.width = '100%';

            stopProgressTimer();

            log('‚úÖ Progresso completo - 100%');
        }

        // Reset para novo teste
        // === FUN√á√ïES DO PAINEL DETALHADO ===

        let currentDetailCategory = null;
        let currentDetailFilter = 'all';

        function openDetailPanel(category) {
            currentDetailCategory = category;
            currentDetailFilter = 'all';

            const panel = document.getElementById('detailPanel');
            const titleEl = document.getElementById('detailPanelTitle');
            const subtitleEl = document.getElementById('detailPanelSubtitle');
            const contentEl = document.getElementById('detailPanelContent');

            // Definir t√≠tulo e dados baseado na categoria
            let title = '';
            let data = [];
            let count = 0;

            switch(category) {
                case 'conciliated':
                    title = '‚úÖ Conciliadas';
                    data = reconciliationResults.conciliated || [];
                    count = data.length;
                    break;
                case 'suggested':
                    title = 'üí° Sugeridas';
                    data = reconciliationResults.suggested || [];
                    count = data.length;
                    break;
                case 'not-conciliated':
                    title = '‚ùå N√£o Conciliadas';
                    // Unificar pendentes + sem correla√ß√£o
                    data = [
                        ...(reconciliationResults.pending || []),
                        ...(reconciliationResults.no_correlation || [])
                    ];
                    count = data.length;
                    break;
            }

            titleEl.textContent = title;
            subtitleEl.textContent = `${count} transa√ß${count === 1 ? '√£o' : '√µes'}`;

            // Renderizar conte√∫do em 2 colunas
            renderTwoColumnView(contentEl, data, category);

            // Mostrar painel
            panel.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevenir scroll do body
        }

        function closeDetailPanel() {
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('show');
            document.body.style.overflow = ''; // Restaurar scroll
            currentDetailCategory = null;
            currentDetailFilter = 'all';
        }

        function filterDetailPanel(filter) {
            currentDetailFilter = filter;
            // Reabrir com o filtro aplicado
            if (currentDetailCategory) {
                openDetailPanel(currentDetailCategory);
            }
        }

        // === FUN√á√ÉO ESPECIAL PARA N√ÉO CONCILIADAS COM CHAT ===

        let currentChatTransactionIndex = 0;
        let chatMessages = {};  // Armazena mensagens por transa√ß√£o: { transactionId: [...messages] }

        function renderNotConciliatedWithChat(container, data) {
            console.log('üí¨ Renderizando modo chat para N√£o Conciliadas');

            // Inicializar com primeira transa√ß√£o
            if (currentChatTransactionIndex >= data.length) {
                currentChatTransactionIndex = 0;
            }

            const currentItem = data[currentChatTransactionIndex];
            const bankTransactions = currentItem.bank_transactions || [currentItem];
            const bankTrans = bankTransactions[0] || {};

            const transactionId = bankTrans.id || bankTrans._id || `not_conciliated_${currentChatTransactionIndex}`;
            const value = Math.abs(parseFloat(bankTrans.value || bankTrans.valor || 0));
            const date = bankTrans.date || bankTrans.data || '';
            const description = bankTrans.description || bankTrans.descricao || 'Sem descri√ß√£o';
            const isExpense = parseFloat(bankTrans.value || bankTrans.valor || 0) < 0;
            const tipo = isExpense ? 'expense' : 'income';

            // Inicializar chat se n√£o existir
            if (!chatMessages[transactionId]) {
                chatMessages[transactionId] = [
                    {
                        role: 'assistant',
                        content: `Ol√°! üëã Esta transa√ß√£o n√£o foi conciliada automaticamente. Como posso ajudar?`,
                        timestamp: new Date().toISOString()
                    }
                ];
            }

            let contentHTML = `
                <!-- Navega√ß√£o entre transa√ß√µes -->
                <div style="background: #f1f5f9; padding: 1rem 2rem; margin: -2rem -2rem 2rem -2rem; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="navigateChatTransaction(-1)" ${currentChatTransactionIndex === 0 ? 'disabled' : ''}
                            style="padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #cbd5e1; background: white; cursor: pointer; font-weight: 600;">
                        ‚Üê Anterior
                    </button>
                    <div style="font-weight: 600; color: #475569;">
                        Transa√ß√£o ${currentChatTransactionIndex + 1} de ${data.length}
                    </div>
                    <button onclick="navigateChatTransaction(1)" ${currentChatTransactionIndex >= data.length - 1 ? 'disabled' : ''}
                            style="padding: 0.5rem 1rem; border-radius: 0.5rem; border: 2px solid #cbd5e1; background: white; cursor: pointer; font-weight: 600;">
                        Pr√≥xima ‚Üí
                    </button>
                </div>

                <!-- Layout 2 Colunas: Transa√ß√£o + Chat -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: calc(100vh - 350px);">

                    <!-- COLUNA ESQUERDA: Transa√ß√£o do Extrato -->
                    <div style="display: flex; flex-direction: column;">
                        <div style="font-weight: 700; color: #1e293b; font-size: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üè¶</span>Extrato Banc√°rio
                        </div>

                        <div class="transaction-item" style="flex: 1;">
                            <div class="transaction-item-header">
                                <div class="transaction-item-title">${description}</div>
                                <div class="transaction-item-value ${tipo}">R$ ${value.toFixed(2)}</div>
                            </div>
                            <div class="transaction-item-details">
                                <div class="transaction-item-detail">üìÖ ${date}</div>
                                <div class="transaction-item-detail">üÜî ${transactionId.substring(0, 20)}...</div>
                                <div class="transaction-item-detail">${tipo === 'income' ? 'üìà Receita' : 'üìâ Despesa'}</div>
                            </div>

                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #f1f5f9;">
                                <div style="font-weight: 600; color: #64748b; margin-bottom: 1rem;">A√ß√µes R√°pidas</div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <button onclick="chatQuickAction('search', '${transactionId}')" class="chat-quick-btn">
                                        üîç Buscar na Base de Dados
                                    </button>
                                    <button onclick="chatQuickAction('create', '${transactionId}')" class="chat-quick-btn">
                                        ‚ú® Criar Novo Documento
                                    </button>
                                    <button onclick="chatQuickAction('skip', '${transactionId}')" class="chat-quick-btn" style="background: #f1f5f9; color: #64748b;">
                                        ‚è≠Ô∏è Pular por Enquanto
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- COLUNA DIREITA: Chat de Assist√™ncia -->
                    <div style="display: flex; flex-direction: column;">
                        <div style="font-weight: 700; color: #1e293b; font-size: 1.2rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üí¨</span>Assistente de Concilia√ß√£o
                        </div>

                        <!-- √Årea de mensagens do chat -->
                        <div id="chatMessagesArea" style="flex: 1; background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; overflow-y: auto; margin-bottom: 1rem;">
                            ${renderChatMessages(transactionId)}
                        </div>

                        <!-- Input de mensagem -->
                        <div style="display: flex; gap: 0.75rem;">
                            <input type="text" id="chatInput" placeholder="Digite sua mensagem..."
                                   onkeypress="if(event.key === 'Enter') sendChatMessage('${transactionId}')"
                                   style="flex: 1; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.95rem;">
                            <button onclick="sendChatMessage('${transactionId}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                Enviar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = contentHTML;

            // Auto-scroll chat para o final
            setTimeout(() => {
                const chatArea = document.getElementById('chatMessagesArea');
                if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;
            }, 100);
        }

        function renderChatMessages(transactionId) {
            const messages = chatMessages[transactionId] || [];

            if (messages.length === 0) {
                return '<div style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhuma mensagem ainda</div>';
            }

            return messages.map(msg => {
                const isUser = msg.role === 'user';
                return `
                    <div style="display: flex; justify-content: ${isUser ? 'flex-end' : 'flex-start'}; margin-bottom: 1rem;">
                        <div style="max-width: 80%; background: ${isUser ? '#3b82f6' : '#f1f5f9'}; color: ${isUser ? 'white' : '#1e293b'};
                                    padding: 0.75rem 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.95rem; line-height: 1.5;">${msg.content}</div>
                            <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.7;">
                                ${new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function navigateChatTransaction(direction) {
            const data = reconciliationResults.pending.concat(reconciliationResults.no_correlation);
            currentChatTransactionIndex += direction;

            if (currentChatTransactionIndex < 0) currentChatTransactionIndex = 0;
            if (currentChatTransactionIndex >= data.length) currentChatTransactionIndex = data.length - 1;

            openDetailPanel('not-conciliated');
        }

        async function sendChatMessage(transactionId) {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Adicionar mensagem do usu√°rio
            if (!chatMessages[transactionId]) chatMessages[transactionId] = [];
            chatMessages[transactionId].push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });

            input.value = '';

            // Re-renderizar chat
            const chatArea = document.getElementById('chatMessagesArea');
            chatArea.innerHTML = renderChatMessages(transactionId);
            chatArea.scrollTop = chatArea.scrollHeight;

            // Mostrar indicador de digita√ß√£o
            chatMessages[transactionId].push({
                role: 'assistant',
                content: 'üí¨ Digitando...',
                timestamp: new Date().toISOString(),
                isTyping: true
            });
            chatArea.innerHTML = renderChatMessages(transactionId);
            chatArea.scrollTop = chatArea.scrollHeight;

            try {
                // Enviar para o backend processar
                const response = await fetch(`${API_BASE_URL}/chat-reconciliation`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        transaction_id: transactionId,
                        message: message,
                        chat_history: chatMessages[transactionId].filter(m => !m.isTyping)
                    })
                });

                const data = await response.json();

                // Remover indicador de digita√ß√£o
                chatMessages[transactionId] = chatMessages[transactionId].filter(m => !m.isTyping);

                // Adicionar resposta do assistente
                chatMessages[transactionId].push({
                    role: 'assistant',
                    content: data.response || 'Desculpe, ocorreu um erro.',
                    timestamp: new Date().toISOString()
                });

                // Re-renderizar
                chatArea.innerHTML = renderChatMessages(transactionId);
                chatArea.scrollTop = chatArea.scrollHeight;

            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);

                // Remover digitando e adicionar erro
                chatMessages[transactionId] = chatMessages[transactionId].filter(m => !m.isTyping);
                chatMessages[transactionId].push({
                    role: 'assistant',
                    content: 'Desculpe, n√£o consegui processar sua mensagem. Tente novamente.',
                    timestamp: new Date().toISOString()
                });

                chatArea.innerHTML = renderChatMessages(transactionId);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function chatQuickAction(action, transactionId) {
            let message = '';

            switch(action) {
                case 'search':
                    message = 'Buscar documentos similares na base de dados';
                    break;
                case 'create':
                    message = 'Criar um novo documento na base de dados para esta transa√ß√£o';
                    break;
                case 'skip':
                    navigateChatTransaction(1);
                    return;
            }

            document.getElementById('chatInput').value = message;
            sendChatMessage(transactionId);
        }

        // === FIM DAS FUN√á√ïES DE CHAT ===

        function renderTwoColumnView(container, data, category) {
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Nenhuma transa√ß√£o encontrada</div>
                        <div style="font-size: 0.95rem;">N√£o h√° dados para exibir nesta categoria</div>
                    </div>
                `;
                return;
            }

            // DEBUG: Log primeiro item para verificar estrutura
            console.log(`üìä Renderizando ${category} - Total de itens:`, data.length);
            if (data.length > 0) {
                console.log('üìã Estrutura do primeiro item:', data[0]);
            }

            // MODO ESPECIAL: Chat para N√£o Conciliadas
            if (category === 'not-conciliated') {
                renderNotConciliatedWithChat(container, data);
                return;
            }

            // NOVA ESTRUTURA: Criar pares de transa√ß√µes lado a lado (n√£o mais 2 colunas separadas)
            let contentHTML = '';

            // Headers das colunas
            contentHTML += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1rem; padding: 0 1rem;">
                    <div style="font-weight: 700; color: #1e293b; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">üè¶</span>Extrato Banc√°rio
                    </div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem;">üíæ</span>Base de Dados
                    </div>
                </div>
            `;

            data.forEach((item, index) => {
                // Estrutura do item pode variar - tentar m√∫ltiplas propriedades
                const bankTransactions = item.bank_transactions ||
                                        (item.value !== undefined || item.valor !== undefined ? [item] : []);

                // Fallbacks para mongo_documents
                let mongoDocuments = item.mongo_documents;

                if (!mongoDocuments || mongoDocuments.length === 0) {
                    if (item.matched_with) {
                        mongoDocuments = [item.matched_with];
                    } else if (item.matched_document) {
                        mongoDocuments = [item.matched_document];
                    } else if (item.matched_document_id || item.system_description) {
                        mongoDocuments = [{
                            _id: item.matched_document_id,
                            id: item.matched_document_id,
                            description: item.system_description,
                            descricao: item.system_description,
                            value: item.system_value,
                            valor: item.system_value,
                            date: item.system_due_date || item.system_settlement_date,
                            data: item.system_due_date || item.system_settlement_date
                        }];
                    } else {
                        mongoDocuments = [];
                    }
                }

                bankTransactions.forEach((bankTrans, bIndex) => {
                    const mongoDoc = mongoDocuments[bIndex] || mongoDocuments[0] || {};

                    const transactionId = bankTrans.id || bankTrans._id || `${category}_${index}_${bIndex}`;
                    const matchedId = mongoDoc._id || mongoDoc.id || '';
                    const value = Math.abs(parseFloat(bankTrans.value || bankTrans.valor || 0));
                    const date = bankTrans.date || bankTrans.data || '';
                    const description = bankTrans.description || bankTrans.descricao || 'Sem descri√ß√£o';

                    const isExpense = parseFloat(bankTrans.value || bankTrans.valor || 0) < 0;
                    const tipo = isExpense ? 'expense' : 'income';

                    // DEBUG: Log dos IDs extra√≠dos (apenas primeira itera√ß√£o)
                    if (index === 0 && bIndex === 0) {
                        console.log('üîç DEBUG - IDs extra√≠dos para checkbox:');
                        console.log('   üìÑ mongoDoc completo:', mongoDoc);
                        console.log('   üÜî matchedId (_id do MongoDB):', matchedId);
                        console.log('   üÜî transactionId (extrato):', transactionId);
                        console.log('   üìä tipo:', tipo);
                        console.log('   üí∞ value:', value);
                    }

                    // Aplicar filtro
                    if (currentDetailFilter !== 'all' && currentDetailFilter !== tipo) {
                        return;
                    }

                    const matchScore = item.match_score || item.confidence_score || 0;
                    const matchPercent = (matchScore * 100).toFixed(0);

                    // CRIAR PAR DE TRANSA√á√ïES LADO A LADO
                    contentHTML += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; padding: 0 1rem;">
                            <!-- COLUNA ESQUERDA: Extrato Banc√°rio -->
                            <div class="transaction-item">
                                ${matchScore > 0 ? `<div class="match-indicator">${matchPercent}% Match</div>` : ''}
                                <div class="transaction-item-header">
                                    <input type="checkbox" class="transaction-item-checkbox transaction-checkbox"
                                           data-transaction-id="${transactionId}"
                                           data-matched-id="${matchedId}"
                                           data-value="${value}"
                                           data-tipo="${tipo}"
                                           data-category="${category}"
                                           onchange="updateSelectedTransactions()">
                                    <div class="transaction-item-title">${description}</div>
                                    <div class="transaction-item-value ${tipo}">R$ ${value.toFixed(2)}</div>
                                </div>
                                <div class="transaction-item-details">
                                    <div class="transaction-item-detail">üìÖ ${date}</div>
                                    <div class="transaction-item-detail">üÜî ${transactionId.substring(0, 12)}...</div>
                                    ${tipo === 'income' ? '<div class="transaction-item-detail">üìà Receita</div>' : '<div class="transaction-item-detail">üìâ Despesa</div>'}
                                </div>
                            </div>

                            <!-- COLUNA DIREITA: Base de Dados -->
                            ${matchedId ? `
                                <div class="transaction-item">
                                    <div class="transaction-item-header">
                                        <div class="transaction-item-title">${mongoDoc.description || mongoDoc.descricao || description}</div>
                                        <div class="transaction-item-value ${tipo}">R$ ${Math.abs(parseFloat(mongoDoc.value || mongoDoc.valor || value)).toFixed(2)}</div>
                                    </div>
                                    <div class="transaction-item-details">
                                        <div class="transaction-item-detail">üìÖ ${mongoDoc.date || mongoDoc.data || date}</div>
                                        <div class="transaction-item-detail">üÜî ${matchedId.substring(0, 12)}...</div>
                                        <div class="transaction-item-detail" style="color: #10b981;">‚úì Match Confirmado</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="transaction-item" style="opacity: 0.5; border-style: dashed;">
                                    <div class="transaction-item-header">
                                        <div class="transaction-item-title">Sem correspond√™ncia</div>
                                    </div>
                                    <div class="transaction-item-details">
                                        <div class="transaction-item-detail" style="color: #ef4444;">‚ùå N√£o encontrado na base</div>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                });
            });

            container.innerHTML = contentHTML;
        }

        // === FIM DAS FUN√á√ïES DO PAINEL DETALHADO ===

        function clearTest() {
            currentFile = null;
            currentSessionId = null;
            preparationTime = 0;
            progressStartTime = 0;

            // Parar timer de progresso e streaming
            stopProgressTimer();
            stopStreaming();

            // Reset contadores de streaming
            resetStreamingCounts();

            // Reset interface principal
            elements.uploadZone.classList.remove('ready');
            elements.uploadTitle.textContent = 'Arraste seu arquivo ou clique aqui';
            elements.uploadSubtitle.textContent = 'OFX, CSV, TXT, XLS, XLSX ‚Ä¢ M√°ximo 16MB';
            elements.smartPreview.classList.remove('show');
            elements.reconcileBtn.disabled = true;
            elements.reconcileBtn.className = 'btn btn-primary';
            elements.reconcileText.textContent = 'Selecione um arquivo';
            elements.performanceBox.classList.remove('show');
            elements.successMessage.style.display = 'none';
            elements.errorMessage.style.display = 'none';
            elements.logSection.textContent = 'üìã Log do Sistema:\n';
            elements.fileInput.value = '';

            // Reset interface de progresso
            document.getElementById('progressContainer').classList.remove('show');
            document.getElementById('financialDashboard').classList.remove('show');

            // Reset interface de streaming
            document.getElementById('streamingSection').style.display = 'none';
            document.getElementById('streamingProgressFill').style.width = '0%';
            document.getElementById('streamConciliated').textContent = '0';
            document.getElementById('streamSuggested').textContent = '0';
            document.getElementById('streamPending').textContent = '0';
            document.getElementById('streamNoCorrelation').textContent = '0';
            document.getElementById('streamingRate').textContent = '0 tx/s';
            document.getElementById('streamingProgressText').textContent = 'Iniciando...';

            // Reset interface de resultados
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('finalConciliated').textContent = '0';
            document.getElementById('finalSuggested').textContent = '0';
            document.getElementById('finalNotConciliated').textContent = '0';
            document.getElementById('finalPending').textContent = '0';
            document.getElementById('finalNoCorrelation').textContent = '0';

            // Fechar painel detalhado se estiver aberto
            closeDetailPanel();

            // Reset steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                const label = document.getElementById(`label${i}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                }
                if (label) {
                    label.classList.remove('active', 'completed');
                }
            }

            // Reset linha e barra de progresso
            document.getElementById('progressLine').style.width = '0%';
            document.getElementById('progressBarFill').style.width = '0%';

            // Reset estat√≠sticas
            document.getElementById('progressTime').textContent = '0s';
            document.getElementById('progressFiles').textContent = '0';
            document.getElementById('progressTransactions').textContent = '0';
            document.getElementById('progressSpeed').textContent = '0%';

            log('üîÑ Sistema resetado para novo teste');
        }
    </script>
</body>
</html>